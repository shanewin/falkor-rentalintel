{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Create New Application</h1>
            <p class="text-muted mb-0">Step-by-step application creation for brokers</p>
        </div>
        <a href="{% url 'applications_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Applications
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Progress Bar -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h6 class="mb-3 text-muted text-uppercase small fw-bold">Application Creation Progress</h6>
            <div class="progress mb-4" style="height: 10px;">
                <div class="progress-bar bg-warning" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="row text-center">
                <div class="col-3">
                    <div class="step text-primary">
                        <div class="step-number bg-warning text-dark fw-bold rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 32px; height: 32px;">1</div>
                        <small class="fw-bold">Property</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="step text-muted">
                        <div class="step-number bg-light text-muted rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 32px; height: 32px;">2</div>
                        <small>Applicant</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="step text-muted">
                        <div class="step-number bg-light text-muted rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 32px; height: 32px;">3</div>
                        <small>Customize</small>
                    </div>
                </div>
                <div class="col-3">
                    <div class="step text-muted">
                        <div class="step-number bg-light text-muted rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" style="width: 32px; height: 32px;">4</div>
                        <small>Review & Send</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <form method="post" id="create-application-form">
                {% csrf_token %}

                <!-- Step 1: Property Selection -->
                <div class="step-section" id="step-property">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-building me-2 text-primary"></i>Step 1: Property Selection</h5>
                        </div>
                        <div class="card-body">
                            <!-- Property Selection Method -->
                            <div class="mb-4">
                                <label class="form-label fw-bold mb-2">Property Selection Method</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="property_type" id="existing_property" value="existing" checked>
                                    <label class="btn btn-outline-primary" for="existing_property">
                                        <i class="fas fa-building me-2"></i>Select from Database
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="property_type" id="manual_property" value="manual">
                                    <label class="btn btn-outline-primary" for="manual_property">
                                        <i class="fas fa-keyboard me-2"></i>Enter Manually
                                    </label>
                                </div>
                                <div class="form-text text-muted mt-2">
                                    <i class="fas fa-info-circle me-1"></i>Choose an existing property or enter details manually
                                </div>
                            </div>

                            <!-- Existing Property Selection -->
                            <div id="existing-property-section" class="bg-light p-4 rounded mb-4">
                                <div class="mb-3">
                                    <label for="apartment" class="form-label fw-bold">Select Apartment</label>
                                    {{ form.apartment }}
                                    <div class="form-text text-muted">
                                        <i class="fas fa-search me-1"></i>Choose an apartment from your available listings
                                    </div>
                                </div>
                            </div>

                            <!-- Manual Property Entry -->
                            <div id="manual-property-section" class="d-none bg-light p-4 rounded mb-4">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="manual_building_name" class="form-label">Building Name</label>
                                            {{ form.manual_building_name }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="manual_unit_number" class="form-label">Unit Number *</label>
                                            {{ form.manual_unit_number }}
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label for="manual_building_address" class="form-label">Full Address *</label>
                                            {{ form.manual_building_address }}
                                            <div class="form-text text-muted">
                                                <i class="fas fa-map-marker-alt me-1"></i>Enter the complete building address
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary btn-lg" onclick="goToStep('applicant')">
                                    Next: Select Applicant <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Applicant Selection -->
                <div class="step-section d-none" id="step-applicant">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-user me-2 text-primary"></i>Step 2: Applicant Selection</h5>
                        </div>
                        <div class="card-body">
                            <!-- Applicant Selection Method -->
                            <div class="mb-4">
                                <label class="form-label fw-bold mb-2">Applicant Selection Method</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="applicant_type" id="existing_applicant" value="existing" checked>
                                    <label class="btn btn-outline-primary" for="existing_applicant">
                                        <i class="fas fa-user me-2"></i>Select Existing
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="applicant_type" id="new_applicant" value="new">
                                    <label class="btn btn-outline-primary" for="new_applicant">
                                        <i class="fas fa-user-plus me-2"></i>Create New
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="applicant_type" id="no_applicant" value="none">
                                    <label class="btn btn-outline-secondary" for="no_applicant">
                                        <i class="fas fa-clock me-2"></i>Add Later
                                    </label>
                                </div>
                                <div class="form-text text-muted mt-2">
                                    <i class="fas fa-info-circle me-1"></i>Choose how to handle applicant information
                                </div>
                            </div>

                            <!-- Existing Applicant Selection -->
                            <div id="existing-applicant-section" class="bg-light p-4 rounded mb-4">
                                <div class="mb-3">
                                    <label for="applicant" class="form-label fw-bold">Select Applicant</label>
                                    {{ form.applicant }}
                                    <div class="form-text text-muted">
                                        <i class="fas fa-search me-1"></i>Choose from your existing applicants
                                    </div>
                                </div>
                            </div>

                            <!-- New Applicant Creation -->
                            <div id="new-applicant-section" class="d-none bg-light p-4 rounded mb-4">
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Quick Applicant Creation:</strong> Just enter basic contact info. The applicant will provide full details when they complete the application.
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_applicant_email" class="form-label">Email Address *</label>
                                            <input type="email" class="form-control" id="new_applicant_email" name="new_applicant_email" 
                                                   placeholder="applicant@example.com" required>
                                            <div class="form-text text-muted">
                                                <i class="fas fa-envelope me-1"></i>We'll send the application link to this email
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_applicant_phone" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="new_applicant_phone" name="new_applicant_phone" 
                                                   placeholder="(555) 123-4567">
                                            <div class="form-text text-muted">
                                                <i class="fas fa-sms me-1"></i>Optional: for SMS notifications
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_applicant_first_name" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="new_applicant_first_name" name="new_applicant_first_name">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="new_applicant_last_name" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="new_applicant_last_name" name="new_applicant_last_name">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- No Applicant Option -->
                            <div id="no-applicant-section" class="d-none">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>No Applicant Selected:</strong> You can add applicant details later and send the application link when ready.
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="goToStep('property')">
                                    <i class="fas fa-arrow-left me-2"></i>Back: Property
                                </button>
                                <button type="button" class="btn btn-primary btn-lg" onclick="goToStep('customize')">
                                    Next: Customize Application <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Application Customization -->
                <div class="step-section d-none" id="step-customize">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-cogs me-2 text-primary"></i>Step 3: Application Customization</h5>
                        </div>
                        <div class="card-body">
                            <!-- Required Documents -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Required Documents</label>
                                <div class="form-text text-muted mb-3">
                                    <i class="fas fa-file-alt me-1"></i>Select which documents the applicant must upload
                                </div>
                                {{ form.required_documents }}
                            </div>

                            <!-- Application Fee -->
                            <div class="mb-4">
                                <label for="application_fee" class="form-label fw-bold">Application Fee</label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="application_fee" name="application_fee" 
                                           value="50.00" step="0.01" min="0">
                                </div>
                                <div class="form-text text-muted">
                                    <i class="fas fa-dollar-sign me-1"></i>Amount the applicant will pay when submitting
                                </div>
                            </div>

                            <!-- Application Notes -->
                            <div class="mb-4">
                                <label for="broker_notes" class="form-label fw-bold">Broker Notes (Optional)</label>
                                <textarea class="form-control" id="broker_notes" name="broker_notes" rows="3" 
                                          placeholder="Any special instructions or notes for this application..."></textarea>
                                <div class="form-text text-muted">
                                    <i class="fas fa-sticky-note me-1"></i>Private notes visible only to you
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary" onclick="goToStep('applicant')">
                                    <i class="fas fa-arrow-left me-2"></i>Back: Applicant
                                </button>
                                <button type="button" class="btn btn-primary btn-lg" onclick="goToStep('review')">
                                    Next: Review & Send <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Review & Send -->
                <div class="step-section d-none" id="step-review">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0"><i class="fas fa-check-circle me-2 text-primary"></i>Step 4: Review & Send Application</h5>
                        </div>
                        <div class="card-body">
                            <!-- Application Summary -->
                            <div class="card mb-4 border-start border-primary border-4 bg-light">
                                <div class="card-header bg-transparent border-bottom-0">
                                    <h6 class="mb-0 fw-bold"><i class="fas fa-clipboard-list me-2"></i>Application Summary</h6>
                                </div>
                                <div class="card-body pt-0">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong><i class="fas fa-building me-2 text-muted"></i>Property:</strong> <span id="summary-property" class="ms-2">-</span></p>
                                            <p class="mb-2"><strong><i class="fas fa-user me-2 text-muted"></i>Applicant:</strong> <span id="summary-applicant" class="ms-2">-</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong><i class="fas fa-file-alt me-2 text-muted"></i>Required Documents:</strong> <span id="summary-documents" class="ms-2">-</span></p>
                                            <p class="mb-2"><strong><i class="fas fa-dollar-sign me-2 text-muted"></i>Application Fee:</strong> <span class="ms-2">$<span id="summary-fee">50.00</span></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Send Options -->
                            <div class="mb-4">
                                <label class="form-label fw-bold mb-3">Send Application Options</label>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check card h-100 p-3 border hover-shadow">
                                            <input class="form-check-input" type="checkbox" id="send_email" name="send_email" checked>
                                            <label class="form-check-label w-100" for="send_email">
                                                <i class="fas fa-envelope me-2 text-primary"></i>Send Email
                                            </label>
                                            <small class="text-muted d-block mt-2" id="email-status">Email will be available if applicant has email address</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check card h-100 p-3 border hover-shadow">
                                            <input class="form-check-input" type="checkbox" id="send_sms" name="send_sms">
                                            <label class="form-check-label w-100" for="send_sms">
                                                <i class="fas fa-sms me-2 text-primary"></i>Send SMS
                                            </label>
                                            <small class="text-muted d-block mt-2" id="sms-status">SMS will be available if applicant has phone number</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check card h-100 p-3 border hover-shadow">
                                            <input class="form-check-input" type="checkbox" id="save_only" name="save_only">
                                            <label class="form-check-label w-100" for="save_only">
                                                <i class="fas fa-save me-2 text-secondary"></i>Save Draft Only
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Contact validation alerts -->
                                <div class="alert alert-info mt-3 d-none" id="contact-validation">
                                    <i class="fas fa-info-circle me-2"></i><span id="contact-message"></span>
                                </div>
                            </div>

                            <!-- Application Preview & Pre-Fill Section -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">Review & Customize Application</label>
                                <div class="form-text text-muted mb-3">
                                    <i class="fas fa-info-circle me-1"></i>Preview the application and optionally pre-fill information for the applicant
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <div class="card h-100 border-light shadow-sm">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-muted text-uppercase small fw-bold mb-3">Preview Application</h6>
                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="openPreviewWindow()">
                                                        <i class="fas fa-external-link-alt me-2"></i>Preview in New Window
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="togglePreviewIframe()">
                                                        <i class="fas fa-eye me-2"></i><span id="iframe-toggle-text">Show Preview Below</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100 border-light shadow-sm">
                                            <div class="card-body text-center">
                                                <h6 class="card-title text-muted text-uppercase small fw-bold mb-3">Pre-Fill Information</h6>
                                                <div class="d-grid gap-2">
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="openPreFillWindow()">
                                                        <i class="fas fa-edit me-2"></i>Pre-Fill Sections
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showPreFillStatus()">
                                                        <i class="fas fa-list-check me-2"></i><span id="prefill-status-text">View Status</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pre-Fill Status Section -->
                                <div id="prefill-status-container" class="alert alert-light border mb-3 d-none">
                                    <h6 class="small mb-2 fw-bold"><i class="fas fa-info-circle me-2"></i>Pre-Fill Status</h6>
                                    <div class="row small" id="prefill-status-content">
                                        <div class="col-md-6">
                                            <div id="section1-status" class="mb-1"><i class="fas fa-circle text-muted me-2"></i>Personal Information: <span class="text-muted">Not started</span></div>
                                            <div id="section2-status" class="mb-1"><i class="fas fa-circle text-muted me-2"></i>Income & Employment: <span class="text-muted">Not started</span></div>
                                        </div>
                                        <div class="col-md-6">
                                            <div id="section3-status" class="mb-1"><i class="fas fa-circle text-muted me-2"></i>Legal History: <span class="text-muted">Not started</span></div>
                                            <div class="text-muted small mt-2">
                                                <i class="fas fa-lightbulb me-1 text-warning"></i>Tip: Pre-fill known information to save applicant time
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Embedded Preview iframe -->
                                <div id="preview-iframe-container" class="border rounded d-none">
                                    <div class="bg-light p-2 small text-muted border-bottom">
                                        <i class="fas fa-info-circle me-2"></i>This is how the application will appear to the applicant
                                    </div>
                                    <iframe id="preview-iframe" src="" width="100%" height="600" frameborder="0"></iframe>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                                <button type="button" class="btn btn-secondary" onclick="goToStep('customize')">
                                    <i class="fas fa-arrow-left me-2"></i>Back: Customize
                                </button>
                                <div class="d-flex gap-2">
                                    <button type="submit" name="action" value="save_draft" class="btn btn-outline-primary">
                                        <i class="fas fa-save me-2"></i>Save as Draft
                                    </button>
                                    <button type="submit" name="action" value="create_and_send" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-2"></i>Create & Send Application
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Property type toggle
    document.querySelectorAll('input[name="property_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const existingSection = document.getElementById('existing-property-section');
            const manualSection = document.getElementById('manual-property-section');
            
            if (this.value === 'existing') {
                existingSection.classList.remove('d-none');
                manualSection.classList.add('d-none');
            } else {
                existingSection.classList.add('d-none');
                manualSection.classList.remove('d-none');
            }
            updateSummary();
        });
    });

    // Applicant type toggle
    document.querySelectorAll('input[name="applicant_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const existingSection = document.getElementById('existing-applicant-section');
            const newSection = document.getElementById('new-applicant-section');
            const noneSection = document.getElementById('no-applicant-section');
            
            // Hide all sections
            existingSection.classList.add('d-none');
            newSection.classList.add('d-none');
            noneSection.classList.add('d-none');
            
            // Show relevant section
            if (this.value === 'existing') {
                existingSection.classList.remove('d-none');
            } else if (this.value === 'new') {
                newSection.classList.remove('d-none');
            } else {
                noneSection.classList.remove('d-none');
            }
            updateSummary();
        });
    });

    // Update summary when inputs change
    document.addEventListener('change', updateSummary);
    document.addEventListener('input', updateSummary);
});

function goToStep(stepName) {
    // Hide all steps
    document.querySelectorAll('.step-section').forEach(section => {
        section.classList.add('d-none');
    });
    
    // Show target step
    document.getElementById('step-' + stepName).classList.remove('d-none');
    
    // Update progress bar
    const steps = ['property', 'applicant', 'customize', 'review'];
    const currentIndex = steps.indexOf(stepName);
    const progressPercent = ((currentIndex + 1) / steps.length) * 100;
    
    document.querySelector('.progress-bar').style.width = progressPercent + '%';
    
    // Update step indicators with new structure
    const stepElements = document.querySelectorAll('.step');
    const stepNumbers = document.querySelectorAll('.step-number');
    
    stepElements.forEach((step, index) => {
        const stepNumber = stepNumbers[index];
        if (index <= currentIndex) {
            step.className = 'step text-primary';
            stepNumber.className = 'step-number bg-warning text-dark fw-bold rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2';
        } else {
            step.className = 'step text-muted';
            stepNumber.className = 'step-number bg-light text-muted rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2';
        }
    });
    
    updateSummary();
}

function updateSummary() {
    // Update property summary
    const propertyType = document.querySelector('input[name="property_type"]:checked')?.value;
    let propertyText = '-';
    
    if (propertyType === 'existing') {
        const apartmentSelect = document.getElementById('id_apartment');
        if (apartmentSelect.value) {
            propertyText = apartmentSelect.options[apartmentSelect.selectedIndex].text;
        }
    } else if (propertyType === 'manual') {
        const buildingName = document.getElementById('id_manual_building_name').value;
        const unitNumber = document.getElementById('id_manual_unit_number').value;
        if (buildingName || unitNumber) {
            propertyText = `${buildingName || 'Building'} - Unit ${unitNumber || 'TBD'}`;
        }
    }
    
    // Update applicant summary
    const applicantType = document.querySelector('input[name="applicant_type"]:checked')?.value;
    let applicantText = '-';
    
    if (applicantType === 'existing') {
        const applicantSelect = document.getElementById('id_applicant');
        if (applicantSelect.value) {
            applicantText = applicantSelect.options[applicantSelect.selectedIndex].text;
        }
    } else if (applicantType === 'new') {
        const email = document.getElementById('new_applicant_email').value;
        const firstName = document.getElementById('new_applicant_first_name').value;
        const lastName = document.getElementById('new_applicant_last_name').value;
        if (email) {
            applicantText = `${firstName || ''} ${lastName || ''} (${email})`.trim();
        }
    } else if (applicantType === 'none') {
        applicantText = 'To be added later';
    }
    
    // Update summaries
    document.getElementById('summary-property').textContent = propertyText;
    document.getElementById('summary-applicant').textContent = applicantText;
    
    // Update documents count
    const selectedDocs = document.querySelectorAll('input[name="required_documents"]:checked').length;
    document.getElementById('summary-documents').textContent = selectedDocs + ' documents';
    
    // Update fee
    const fee = document.getElementById('application_fee')?.value || '50.00';
    document.getElementById('summary-fee').textContent = fee;
    
    // Update contact validation
    updateContactValidation();
}

function updateContactValidation() {
    const applicantType = document.querySelector('input[name="applicant_type"]:checked')?.value;
    let hasEmail = false;
    let hasPhone = false;
    
    // Check contact info based on applicant type
    if (applicantType === 'existing') {
        const applicantSelect = document.getElementById('id_applicant');
        if (applicantSelect && applicantSelect.value) {
            // Get selected applicant data (would need AJAX in real implementation)
            // For now, assume both are available for existing applicants
            hasEmail = true;
            hasPhone = true;
        }
    } else if (applicantType === 'new') {
        const email = document.getElementById('new_applicant_email')?.value;
        const phone = document.getElementById('new_applicant_phone')?.value;
        hasEmail = Boolean(email && email.trim());
        hasPhone = Boolean(phone && phone.trim());
    }
    
    // Update UI based on available contact methods
    const emailCheckbox = document.getElementById('send_email');
    const smsCheckbox = document.getElementById('send_sms');
    const emailStatus = document.getElementById('email-status');
    const smsStatus = document.getElementById('sms-status');
    const contactValidation = document.getElementById('contact-validation');
    const contactMessage = document.getElementById('contact-message');
    
    // Email validation
    if (hasEmail) {
        emailCheckbox.disabled = false;
        emailStatus.textContent = '✓ Email available';
        emailStatus.className = 'text-success d-block mt-2';
    } else {
        emailCheckbox.disabled = true;
        emailCheckbox.checked = false;
        emailStatus.textContent = '✗ No email address provided';
        emailStatus.className = 'text-muted d-block mt-2';
    }
    
    // SMS validation
    if (hasPhone) {
        smsCheckbox.disabled = false;
        smsStatus.textContent = '✓ Phone number available';
        smsStatus.className = 'text-success d-block mt-2';
    } else {
        smsCheckbox.disabled = true;
        smsCheckbox.checked = false;
        smsStatus.textContent = '✗ No phone number provided';
        smsStatus.className = 'text-muted d-block mt-2';
    }
    
    // Show validation message
    if (!hasEmail && !hasPhone) {
        contactMessage.textContent = 'No contact information available. Application will be saved as draft only.';
        contactValidation.className = 'alert alert-warning mt-3';
        contactValidation.classList.remove('d-none');
    } else if (hasEmail && hasPhone) {
        contactMessage.textContent = 'Both email and SMS options are available.';
        contactValidation.className = 'alert alert-success mt-3';
        contactValidation.classList.remove('d-none');
    } else if (hasEmail) {
        contactMessage.textContent = 'Only email option is available.';
        contactValidation.className = 'alert alert-info mt-3';
        contactValidation.classList.remove('d-none');
    } else if (hasPhone) {
        contactMessage.textContent = 'Only SMS option is available.';
        contactValidation.className = 'alert alert-info mt-3';
        contactValidation.classList.remove('d-none');
    } else {
        contactValidation.classList.add('d-none');
    }
}

// Preview functionality
let tempApplicationId = null;

function openPreviewWindow() {
    if (!tempApplicationId) {
        // Create a temporary application first
        createTempApplication(() => {
            const previewUrl = `/applications/${tempApplicationId}/preview/`;
            window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        });
    } else {
        const previewUrl = `/applications/${tempApplicationId}/preview/`;
        window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
    }
}

function togglePreviewIframe() {
    const container = document.getElementById('preview-iframe-container');
    const iframe = document.getElementById('preview-iframe');
    const toggleText = document.getElementById('iframe-toggle-text');
    
    if (container.classList.contains('d-none')) {
        if (!tempApplicationId) {
            // Create a temporary application first
            createTempApplication(() => {
                const previewUrl = `/applications/${tempApplicationId}/preview/`;
                iframe.src = previewUrl;
                container.classList.remove('d-none');
                toggleText.textContent = 'Hide Preview';
            });
        } else {
            const previewUrl = `/applications/${tempApplicationId}/preview/`;
            iframe.src = previewUrl;
            container.classList.remove('d-none');
            toggleText.textContent = 'Hide Preview';
        }
    } else {
        container.classList.add('d-none');
        toggleText.textContent = 'Show Preview Below';
    }
}

function createTempApplication(callback) {
    // Collect form data
    const formData = new FormData(document.getElementById('create-application-form'));
    formData.append('action', 'create_temp_preview');
    
    fetch('/applications/broker/create/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            tempApplicationId = data.application_id;
            if (callback) callback();
        } else {
            alert('Error creating preview: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating preview. Please check your form data.');
    });
}

// Pre-fill functionality
function openPreFillWindow() {
    if (!tempApplicationId) {
        // Create a temporary application first
        createTempApplication(() => {
            const preFillUrl = `/applications/${tempApplicationId}/broker-prefill/`;
            window.open(preFillUrl, '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
        });
    } else {
        const preFillUrl = `/applications/${tempApplicationId}/broker-prefill/`;
        window.open(preFillUrl, '_blank', 'width=1400,height=900,scrollbars=yes,resizable=yes');
    }
}

function showPreFillStatus() {
    const container = document.getElementById('prefill-status-container');
    const toggleText = document.getElementById('prefill-status-text');
    
    if (container.classList.contains('d-none')) {
        // Update status if we have an application
        if (tempApplicationId) {
            updatePreFillStatus();
        }
        container.classList.remove('d-none');
        toggleText.textContent = 'Hide Status';
    } else {
        container.classList.add('d-none');
        toggleText.textContent = 'View Status';
    }
}

function updatePreFillStatus() {
    if (!tempApplicationId) return;
    
    // Fetch current pre-fill status
    fetch(`/applications/${tempApplicationId}/prefill-status/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatusIndicator('section1-status', 'Personal Information', data.status.section1);
            updateStatusIndicator('section2-status', 'Income & Employment', data.status.section2);
            updateStatusIndicator('section3-status', 'Legal History', data.status.section3);
        }
    })
    .catch(error => {
        console.error('Error fetching prefill status:', error);
    });
}

function updateStatusIndicator(elementId, sectionName, status) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    let icon, text, color;
    if (status === 'completed') {
        icon = 'fa-check-circle';
        text = 'Completed';
        color = 'text-success';
    } else if (status === 'partial') {
        icon = 'fa-adjust';
        text = 'In Progress';
        color = 'text-warning';
    } else {
        icon = 'fa-circle';
        text = 'Not started';
        color = 'text-muted';
    }
    
    element.innerHTML = `<i class="fas ${icon} ${color} me-2"></i>${sectionName}: <span class="${color}">${text}</span>`;
}
</script>
{% endblock %}