{% extends 'base.html' %}
{% load static %}
{% load json_filters %}


{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Application Overview</h2>

    <!-- Application Progress -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Application for {% if application.apartment %}{{ application.apartment.building.name }} - Unit {{ application.apartment.unit_number }}{% else %}{{ application.get_building_display }} - Unit {{ application.get_unit_display }}{% endif %}</h5>
            <a href="{% url 'application_edit' application.id %}" class="btn btn-light btn-sm">
                <i class="fas fa-edit"></i> Edit
            </a>
        </div>
        <div class="card-body">
            <!-- Section Progress Overview -->
            <h6 class="mb-3 text-muted text-uppercase fw-bold">Application Progress</h6>
            <div class="row g-3">
                <!-- Section 1: Personal Information -->
                <div class="col-md-6 col-lg-2">
                    <div class="card h-100 {% if application.personal_info_data %}border-success{% else %}border-secondary{% endif %}">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                {% if application.personal_info_data %}
                                    <i class="fas fa-check-circle text-success fa-2x"></i>
                                {% else %}
                                    <i class="far fa-circle text-secondary fa-2x"></i>
                                {% endif %}
                            </div>
                            <h6 class="card-title">Personal Info</h6>
                            <a href="{% url 'section1_personal_info' application.id %}" class="btn btn-sm w-100
                                {% if application.personal_info_data %}btn-success{% else %}btn-outline-primary{% endif %}">
                                {% if application.personal_info_data %}Review{% else %}Start{% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Income -->
                <div class="col-md-6 col-lg-2">
                    <div class="card h-100 {% if application.income_data %}border-success{% else %}border-secondary{% endif %}">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                {% if application.income_data %}
                                    <i class="fas fa-check-circle text-success fa-2x"></i>
                                {% else %}
                                    <i class="far fa-circle text-secondary fa-2x"></i>
                                {% endif %}
                            </div>
                            <h6 class="card-title">Income</h6>
                            <a href="{% url 'section2_income' application.id %}" class="btn btn-sm w-100
                                {% if application.income_data %}btn-success{% else %}btn-outline-primary{% endif %}">
                                {% if application.income_data %}Review{% else %}Start{% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Legal -->
                <div class="col-md-6 col-lg-2">
                    <div class="card h-100 {% if application.legal_documents %}border-success{% else %}border-secondary{% endif %}">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                {% if application.legal_documents %}
                                    <i class="fas fa-check-circle text-success fa-2x"></i>
                                {% else %}
                                    <i class="far fa-circle text-secondary fa-2x"></i>
                                {% endif %}
                            </div>
                            <h6 class="card-title">Legal</h6>
                            <a href="{% url 'section3_legal' application.id %}" class="btn btn-sm w-100
                                {% if application.legal_documents %}btn-success{% else %}btn-outline-primary{% endif %}">
                                {% if application.legal_documents %}Review{% else %}Start{% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Review -->
                <div class="col-md-6 col-lg-2">
                    <div class="card h-100 {% if application.review_completed %}border-success{% else %}border-secondary{% endif %}">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                {% if application.review_completed %}
                                    <i class="fas fa-check-circle text-success fa-2x"></i>
                                {% else %}
                                    <i class="far fa-circle text-secondary fa-2x"></i>
                                {% endif %}
                            </div>
                            <h6 class="card-title">Review</h6>
                            <a href="{% url 'section4_review' application.id %}" class="btn btn-sm w-100
                                {% if application.review_completed %}btn-success{% else %}btn-outline-primary{% endif %}">
                                {% if application.review_completed %}View{% else %}Start{% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Payment -->
                <div class="col-md-6 col-lg-2">
                    <div class="card h-100 {% if application.application_payment %}border-success{% else %}border-secondary{% endif %}">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                {% if application.application_payment %}
                                    <i class="fas fa-check-circle text-success fa-2x"></i>
                                {% else %}
                                    <i class="far fa-circle text-secondary fa-2x"></i>
                                {% endif %}
                            </div>
                            <h6 class="card-title">Payment</h6>
                            <a href="{% url 'section5_payment' application.id %}" class="btn btn-sm w-100
                                {% if application.application_payment %}btn-success{% else %}btn-outline-primary{% endif %}">
                                {% if application.application_payment %}View{% else %}Pay{% endif %}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Overall Progress -->
                <div class="col-md-6 col-lg-2">
                    <div class="card h-100 border-info">
                        <div class="card-body text-center p-3">
                            <div class="mb-2">
                                <i class="fas fa-chart-pie text-info fa-2x"></i>
                            </div>
                            <h6 class="card-title">Progress</h6>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ application.completion_percentage }}%;" aria-valuenow="{{ application.completion_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ application.completion_percentage }}%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Application Summary -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Application Summary</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Applicant:</strong> 
                        {% if application.applicant %}
                            {{ application.applicant.first_name }} {{ application.applicant.last_name }}
                        {% elif application.personal_info_data %}
                            {{ application.personal_info_data.first_name|default:"[Not provided]" }} {{ application.personal_info_data.last_name|default:"" }}
                        {% else %}
                            <span class="text-muted">No applicant assigned yet</span>
                        {% endif %}
                    </p>
                    <p><strong>Property:</strong> 
                        {% if application.apartment %}
                            <a href="{% url 'apartment_overview' application.apartment.id %}" target="_blank" class="text-decoration-none">
                                {{ application.apartment.building.name }} - Unit {{ application.apartment.unit_number }}
                            </a>
                        {% else %}
                            {{ application.get_building_display }} - Unit {{ application.get_unit_display }}
                            <small class="text-muted">(Manual Entry)</small>
                            <br><small class="text-muted">{{ application.get_address_display }}</small>
                        {% endif %}
                    </p>
                    <p><strong>Broker:</strong> 
                        {% if application.broker %}
                            {{ application.broker.get_full_name|default:application.broker.email }}
                        {% else %}
                            <i class="text-muted">No Broker Assigned</i>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6">
                    <p><strong>Application Status:</strong>
                        <span class="badge rounded-pill
                            {% if application.get_status_display == 'New' %} bg-primary
                            {% elif application.get_status_display == 'Pending Review' %} bg-warning text-dark
                            {% elif application.get_status_display == 'Approved' %} bg-success
                            {% elif application.get_status_display == 'Rejected' %} bg-danger
                            {% elif application.get_status_display == 'Waitlisted' %} bg-info
                            {% else %} bg-secondary
                            {% endif %}">
                            {{ application.get_dynamic_status }}
                        </span>
                    </p>

                    <p><strong>Submitted by Applicant:</strong> 
                        {% if application.submitted_by_applicant %}
                            <span class="badge bg-success">‚úÖ Yes</span>
                        {% else %}
                            <span class="badge bg-danger">‚ùå No</span>
                        {% endif %}
                    </p>

                    <div class="mb-2">
                        <strong>Application Link:</strong> 
                        <div class="input-group mb-2">
                            <input type="text" id="app-link" class="form-control" 
                                   value="{{ request.scheme }}://{{ request.get_host }}{% url 'applicant_complete' uuid=application.unique_link %}?token={{ application.unique_link }}" 
                                   readonly>
                            <button class="btn btn-secondary" onclick="copyToClipboard()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        {% if user.is_broker or user.is_superuser %}
                            {% if application.applicant and application.applicant.email %}
                                <div class="d-flex gap-2 align-items-center">
                                    <a href="{% url 'send_application_link' application.id %}" 
                                       class="btn btn-success btn-sm"
                                       onclick="return confirm('Send application link to {{ application.applicant.email }}?')">
                                        <i class="fas fa-envelope"></i> Send Link via Email
                                    </a>
                                    <small class="text-muted">to {{ application.applicant.email }}</small>
                                </div>
                            {% else %}
                                <div class="alert alert-warning py-1 px-2 d-inline-block mb-0">
                                    <small><i class="fas fa-exclamation-triangle"></i> No applicant email - cannot send automatically</small>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <script>
                function copyToClipboard() {
                    const input = document.getElementById("app-link");
                    input.select();
                    document.execCommand("copy");
                    alert("Application link copied!");
                }
            </script>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Activity Log</h5>
        </div>
        <div class="card-body">
            {% if application.activity_log.all %}
                <ul class="list-group list-group-flush">
                    {% for log in application.activity_log.all|slice:":3" %}
                        <li class="list-group-item">
                            <strong>{{ log.timestamp|date:"M d, Y H:i" }}</strong> - {{ log.description }}
                        </li>
                    {% endfor %}
                </ul>

                {% if application.activity_log.all|length > 3 %}
                    <!-- Show More Button -->
                    <button class="btn btn-link mt-2 text-decoration-none" data-bs-toggle="collapse" data-bs-target="#allActivityLogs">
                        Show More
                    </button>

                    <!-- Collapsible Section for All Logs -->
                    <div class="collapse mt-2" id="allActivityLogs">
                        <ul class="list-group list-group-flush">
                            {% for log in application.activity_log.all|slice:"3:" %}
                                <li class="list-group-item">
                                    <strong>{{ log.timestamp|date:"M d, Y H:i" }}</strong> - {{ log.description }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            {% else %}
                <p class="text-muted mb-0">No recorded activity yet.</p>
            {% endif %}
        </div>
    </div>


    <!-- Applicant Information -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Applicant Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> {{ application.applicant.first_name }} {{ application.applicant.last_name }}</p>
                    <p><strong>Date of Birth:</strong> {{ application.applicant.date_of_birth }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Email:</strong> {{ application.applicant.email }}</p>
                    <p><strong>Phone:</strong> {{ application.applicant.phone_number|default:"N/A" }}</p>
                </div>
                <div class="col-12">
                    <p><strong>Address:</strong> {{ application.applicant.street_address_1 }}, {{ application.applicant.city }}, {{ application.applicant.state }} {{ application.applicant.zip_code }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Uploaded Files -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Uploaded Documents</h5>
        </div>
        
        {% if messages %}
            <div class="p-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-2" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="card-body">
            {% if application.uploaded_files.all %}
                <div class="list-group">
                    {% for file in application.uploaded_files.all %}
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                <h6 class="mb-1">
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {{ file.document_type|default:"Unknown Document" }}
                                </h6>
                                <small class="text-muted">{{ file.uploaded_at|date:"M d, Y" }}</small>
                            </div>
                            
                            <!-- Analysis Results (if any) -->
                            {% if file.analysis_results %}
                                <div class="alert alert-light border mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>üìä Analysis Results</strong>
                                        <span class="badge 
                                            {% if file.analysis_results.status == "Complete" %} bg-success 
                                            {% elif file.analysis_results.status == "Needs Manual Review" %} bg-warning text-dark
                                            {% else %} bg-danger {% endif %}">
                                            {{ file.analysis_results.status }}
                                        </span>
                                    </div>
                                    
                                    {% if file.analysis_results.summary %}
                                        <p class="mb-1 small"><strong>Summary:</strong> {{ file.analysis_results.summary }}</p>
                                    {% endif %}
                                    
                                    {% if file.analysis_results.reasoning %}
                                        <div class="alert alert-warning py-1 px-2 mb-1 small">
                                            <strong>‚ö†Ô∏è Flagged:</strong> {{ file.analysis_results.reasoning }}
                                        </div>
                                    {% endif %}
                                    
                                    {% if file.analysis_results.modification_check %}
                                        <div class="alert alert-info py-1 px-2 mb-0 small">
                                            <strong>üõë Modification Check:</strong> {{ file.analysis_results.modification_check }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}

                            <div class="d-flex gap-2 flex-wrap mt-2">
                                <a href="{{ file.file.url }}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="fas fa-search"></i> View
                                </a>
                                <a href="{{ file.file.url }}" download class="btn btn-secondary btn-sm">
                                    <i class="fas fa-download"></i> Download
                                </a>

                                <!-- Analyze Button -->
                                <form action="{% url 'analyze_uploaded_file' file.id %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-info btn-sm text-white">
                                        <i class="fas fa-chart-bar"></i> Analyze
                                    </button>
                                </form>

                                <!-- Delete Button -->
                                {% if user.is_authenticated and user.is_superuser or user == application.broker %}
                                    <form action="{% url 'delete_uploaded_file' file.id %}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                {% endif %}
                            </div>

                            <!-- PDF Preview -->
                            {% if file.file.url|lower|slice:"-4:" == ".pdf" %}
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#pdfPreview{{ file.id }}">
                                        Toggle Preview
                                    </button>
                                    <div class="collapse mt-2" id="pdfPreview{{ file.id }}">
                                        <iframe src="{{ file.file.url }}" width="100%" height="400px" class="border rounded"></iframe>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No documents uploaded yet.</p>
                </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}
