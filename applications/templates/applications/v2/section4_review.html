{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Application Review</h4>
                </div>
                <div class="card-body">
                    
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Application Progress</label>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 80%;" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100">Step 4 of 5</div>
                        </div>
                    </div>

                    <!-- Section Navigation -->
                    <div class="d-flex justify-content-between mb-4 text-center">
                        <div class="flex-fill text-muted">
                            <span class="badge bg-success rounded-pill mb-1"><i class="fas fa-check"></i></span>
                            <br><small>Personal</small>
                        </div>
                        <div class="flex-fill text-muted">
                            <span class="badge bg-success rounded-pill mb-1"><i class="fas fa-check"></i></span>
                            <br><small>Income</small>
                        </div>
                        <div class="flex-fill text-muted">
                            <span class="badge bg-success rounded-pill mb-1"><i class="fas fa-check"></i></span>
                            <br><small>Legal</small>
                        </div>
                        <div class="flex-fill">
                            <span class="badge bg-primary rounded-pill mb-1">4</span>
                            <br><small class="fw-bold">Review</small>
                        </div>
                        <div class="flex-fill text-muted">
                            <span class="badge bg-secondary rounded-pill mb-1">5</span>
                            <br><small>Payment</small>
                        </div>
                    </div>

                    <p class="text-muted mb-4">Please review all information before proceeding to payment.</p>
                    
                    {% if not all_sections_complete %}
                    <div class="alert alert-warning mb-4">
                        <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Incomplete Sections</h5>
                        <ul class="mb-0 ps-3">
                            {% if not sections_complete.personal %}<li>Personal Information: {{ sections_complete.personal_message }}</li>{% endif %}
                            {% if not sections_complete.income %}<li>Income Information: {{ sections_complete.income_message }}</li>{% endif %}
                            {% if not sections_complete.legal %}<li>Legal Documents not signed</li>{% endif %}
                            {% if not sections_complete.required_docs %}<li>Required Documents: {{ sections_complete.docs_message }}</li>{% endif %}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <!-- Section 1: Personal Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 border-light shadow-sm">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 text-primary">Personal Information</h5>
                                    {% if is_applicant_access %}
                                    <a href="{% url 'section1_personal_info' application.id %}?token={{ token }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></a>
                                    {% else %}
                                    <a href="{% url 'section1_personal_info' application.id %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></a>
                                    {% endif %}
                                </div>
                                <div class="card-body">
                                    {% if personal_info %}
                                        <p class="mb-1"><strong>Name:</strong> {{ personal_info.first_name }} {{ personal_info.last_name }}</p>
                                        <p class="mb-1"><strong>Email:</strong> {{ personal_info.email|default:"Not provided" }}</p>
                                        <p class="mb-1"><strong>Phone:</strong> {{ personal_info.phone_cell|default:"Not provided" }}</p>
                                        <p class="mb-1"><strong>DOB:</strong> {{ personal_info.date_of_birth|default:"Not provided" }}</p>
                                        <hr>
                                        <p class="mb-1"><strong>Current Address:</strong> {{ personal_info.current_address|default:"Not provided" }}</p>
                                        <p class="mb-1"><strong>Desired Property:</strong> {{ property_display }}</p>
                                        <p class="mb-1"><strong>Unit:</strong> {{ unit_display }}</p>
                                        <p class="mb-0"><strong>Move-in Date:</strong> {{ personal_info.desired_move_in_date|default:"Not provided" }}</p>
                                        
                                        {% if previous_addresses %}
                                        <h6 class="mt-3 text-muted">Previous Addresses:</h6>
                                        <ul class="list-unstyled mb-0 small">
                                            {% for addr in previous_addresses %}
                                            <li><i class="fas fa-map-marker-alt me-1 text-muted"></i> {{ addr.address }} ({{ addr.duration }})</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted fst-italic">Not yet completed</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 2: Income Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 border-light shadow-sm">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 text-primary">Income & Employment</h5>
                                    {% if is_applicant_access %}
                                    <a href="{% url 'section2_income' application.id %}?token={{ token }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></a>
                                    {% else %}
                                    <a href="{% url 'section2_income' application.id %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></a>
                                    {% endif %}
                                </div>
                                <div class="card-body">
                                    {% if income_data %}
                                        <p class="mb-1"><strong>Employment:</strong> {{ income_data.get_employment_type_display }}</p>
                                        <p class="mb-1"><strong>Company:</strong> {{ income_data.company_name }}</p>
                                        <p class="mb-1"><strong>Position:</strong> {{ income_data.position }}</p>
                                        <p class="mb-1"><strong>Annual Income:</strong> ${{ income_data.annual_income|floatformat:2 }}</p>
                                        <p class="mb-1"><strong>Supervisor:</strong> {{ income_data.supervisor_name }}</p>
                                        <p class="mb-0"><strong>Start Date:</strong> {{ income_data.start_date }}</p>
                                        
                                        {% if additional_jobs %}
                                        <h6 class="mt-3 text-muted">Additional Employment:</h6>
                                        <ul class="list-unstyled mb-0 small">
                                            {% for job in additional_jobs %}
                                            <li><i class="fas fa-briefcase me-1 text-muted"></i> {{ job.company_name }} - {{ job.position }} (${{ job.annual_income|floatformat:2 }}/year)</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                        
                                        {% if additional_income %}
                                        <h6 class="mt-3 text-muted">Other Income:</h6>
                                        <ul class="list-unstyled mb-0 small">
                                            {% for income in additional_income %}
                                            <li><i class="fas fa-money-bill-wave me-1 text-muted"></i> {{ income.source_name }} (${{ income.annual_amount|floatformat:2 }}/year)</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                        
                                        {% if assets %}
                                        <h6 class="mt-3 text-muted">Assets:</h6>
                                        <ul class="list-unstyled mb-0 small">
                                            {% for asset in assets %}
                                            <li><i class="fas fa-piggy-bank me-1 text-muted"></i> {{ asset.asset_name }} (${{ asset.account_balance|floatformat:2 }})</li>
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted fst-italic">Not yet completed</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Section 3: Legal Documents -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 border-light shadow-sm">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 text-primary">Legal Documents</h5>
                                    {% if is_applicant_access %}
                                    <a href="{% url 'section3_legal' application.id %}?token={{ token }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></a>
                                    {% else %}
                                    <a href="{% url 'section3_legal' application.id %}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></a>
                                    {% endif %}
                                </div>
                                <div class="card-body">
                                    {% if legal_docs %}
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                            <span>NY Discrimination Form</span>
                                            {% if legal_docs.discrimination_form_signed %}
                                            <span class="badge bg-success rounded-pill"><i class="fas fa-check me-1"></i> Signed {{ legal_docs.discrimination_form_signed_at|date:"M d, Y" }}</span>
                                            {% else %}
                                            <span class="badge bg-danger rounded-pill"><i class="fas fa-times me-1"></i> Not Signed</span>
                                            {% endif %}
                                        </li>
                                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                            <span>NY Brokers Form</span>
                                            {% if legal_docs.brokers_form_signed %}
                                            <span class="badge bg-success rounded-pill"><i class="fas fa-check me-1"></i> Signed {{ legal_docs.brokers_form_signed_at|date:"M d, Y" }}</span>
                                            {% else %}
                                            <span class="badge bg-danger rounded-pill"><i class="fas fa-times me-1"></i> Not Signed</span>
                                            {% endif %}
                                        </li>
                                    </ul>
                                    {% else %}
                                    <p class="text-muted fst-italic">Not yet completed</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Uploaded Documents -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 border-light shadow-sm">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0 text-primary">Uploaded Documents</h5>
                                </div>
                                <div class="card-body">
                                    {% if required_documents_list %}
                                    <h6 class="text-muted">Required:</h6>
                                    <ul class="list-group list-group-flush mb-3">
                                        {% for doc_type, status in required_documents_status.items %}
                                        <li class="list-group-item px-0 d-flex justify-content-between align-items-center">
                                            <span>{{ status.display_name }}</span>
                                            {% if status.uploaded %}
                                            <span class="badge bg-success rounded-pill"><i class="fas fa-check me-1"></i> Uploaded</span>
                                            {% else %}
                                            <span class="badge bg-danger rounded-pill"><i class="fas fa-times me-1"></i> Missing</span>
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                    
                                    {% if uploaded_files %}
                                    <h6 class="text-muted">All Files:</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Type</th>
                                                    <th>Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for file in uploaded_files %}
                                                <tr>
                                                    <td>{{ file.document_type|default:"Other" }}</td>
                                                    <td>{{ file.uploaded_at|date:"M d" }}</td>
                                                    <td>
                                                        {% if file.analysis_results %}
                                                        <span class="badge bg-success">Analyzed</span>
                                                        {% else %}
                                                        <span class="badge bg-secondary">Pending</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <p class="text-muted fst-italic">No documents uploaded</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirmation and Payment -->
                    {% if all_sections_complete %}
                    <div class="card border-success bg-light mb-4">
                        <div class="card-body text-center">
                            <h4 class="text-success mb-3"><i class="fas fa-check-circle me-2"></i>Application Ready</h4>
                            <p class="lead mb-4">All required sections and documents have been completed. Please proceed to payment to finalize your application.</p>
                            <form method="post">
                                {% csrf_token %}
                                <button type="submit" name="confirm_proceed" class="btn btn-success btn-lg px-5 shadow-sm">
                                    Confirm and Proceed to Payment <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="card border-warning bg-light mb-4">
                        <div class="card-body text-center">
                            <h4 class="text-warning mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Application Incomplete</h4>
                            <p class="lead mb-4">Please complete all required sections and upload all required documents before proceeding to payment.</p>
                            <button class="btn btn-secondary btn-lg px-5" disabled>
                                Cannot Proceed - Complete All Sections
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Navigation -->
                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                        {% if is_applicant_access %}
                        <a href="{% url 'v2_application_overview' application.id %}?token={{ token }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Overview
                        </a>
                        {% else %}
                        <a href="{% url 'application_detail' application.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Back to Application
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}