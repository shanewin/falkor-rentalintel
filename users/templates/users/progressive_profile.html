{% extends 'base.html' %}

{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
    {{ form.media.css }}
    <link rel="stylesheet" href="{% static 'css/doorway-forms.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center pb-2 mb-4 border-bottom page-header">
        <h1 class="h5 fw-bold text-dark mb-0">
            My Profile
        </h1>
        {% if profile_type == 'Administrator' %}
        <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
        {% endif %}
    </div>

    <!-- Success Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Profile Completion Progress - ONLY show for non-admin users -->
    {% if not user.is_superuser %}
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-2">Profile Completion</h5>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" role="progressbar" 
                             style="width: {{ completion_percentage }}%;" 
                             aria-valuenow="{{ completion_percentage }}" 
                             aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted">{{ completion_percentage }}% Complete</small>
                </div>
                <div class="col-md-4 text-end">
                    {% if completion_percentage == 100 %}
                        <span class="badge bg-success fs-6">âœ“ Complete</span>
                    {% else %}
                        <span class="badge bg-warning fs-6">In Progress</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Next Steps Card - ONLY show for non-admin users -->
    {% if next_steps and not user.is_superuser %}
    <div class="card shadow-sm mb-4 border-warning">
        <div class="card-header bg-warning bg-opacity-10">
            <h6 class="mb-0 text-warning-emphasis">
                <i class="bi bi-list-check"></i> Recommended Next Steps
            </h6>
        </div>
        <div class="card-body">
            <ul class="list-unstyled mb-0">
                {% for step in next_steps %}
                    <li class="mb-2">
                        <i class="bi bi-arrow-right text-warning"></i> {{ step }}
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Profile Form -->
    <div>
        <div class="card shadow-sm">
            <div class="card-body p-4">
                
                <form method="post" enctype="multipart/form-data" class="doorway-form admin-profile-form">
                {% csrf_token %}
                
                <!-- Custom Photo Upload Section -->
                {% if profile_type == 'Administrator' %}
                <div class="mb-4 profile-photo-section">
                    <label class="form-label profile-photo-label">Profile Photo:</label>
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <div class="profile-photo-container position-relative">
                                {% if form.instance.profile_photo %}
                                    <img src="{{ form.instance.profile_photo.url }}" 
                                         alt="Profile Photo" 
                                         class="rounded-circle border border-2 border-warning" 
                                         width="120" 
                                         height="120" 
                                         style="object-fit: cover;"
                                         id="photo-preview">
                                    <div class="delete-photo-btn" onclick="removePhoto()" title="Remove photo">
                                        <i class="fas fa-times"></i>
                                    </div>
                                {% else %}
                                    <div class="bg-light rounded-circle border border-2 border-secondary d-flex align-items-center justify-content-center" 
                                         style="width: 120px; height: 120px;"
                                         id="photo-placeholder">
                                        <i class="fas fa-user fa-3x text-muted"></i>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col">
                            <h6 class="mb-2">Upload Your Profile Photo</h6>
                            <p class="text-muted small mb-3">Choose a professional photo that represents you well. Accepted formats: JPG, PNG, GIF (max 10MB)</p>
                            
                            <div class="d-flex gap-2 mb-3">
                                <button type="button" 
                                        class="btn btn-primary btn-sm"
                                        onclick="document.getElementById('id_profile_photo').click()">
                                    <i class="fas fa-camera"></i> 
                                    {% if form.instance.profile_photo %}Change Photo{% else %}Upload Photo{% endif %}
                                </button>
                                <button type="button" 
                                        class="btn btn-outline-secondary btn-sm"
                                        onclick="previewPhoto()"
                                        id="preview-btn"
                                        style="{% if not form.instance.profile_photo %}display: none;{% endif %}">
                                    <i class="fas fa-eye"></i> View Full Size
                                </button>
                                <button type="button" 
                                        class="btn btn-outline-warning btn-sm"
                                        onclick="showCropControls()"
                                        id="crop-btn"
                                        style="{% if not form.instance.profile_photo %}display: none;{% endif %}">
                                    <i class="fas fa-crop"></i> Crop & Zoom
                                </button>
                            </div>
                            
                            <input type="file" 
                                   name="profile_photo" 
                                   id="id_profile_photo" 
                                   accept="image/*"
                                   style="display: none;"
                                   class="form-control">
                                   
                            <!-- Crop transformation data -->
                            <input type="hidden" id="crop-data" name="crop_data" value="">
                        </div>
                    </div>
                    
                    <!-- Crop and Zoom Controls -->
                    <div class="crop-controls" id="crop-controls" style="display: none;">
                        <h6 class="fw-bold mb-3"><i class="fas fa-crop"></i> Crop & Zoom Your Photo</h6>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Zoom Level</label>
                                <input type="range" 
                                       id="zoom-slider" 
                                       class="crop-slider" 
                                       min="100" 
                                       max="300" 
                                       value="100" 
                                       oninput="updateCrop()">
                                <small class="text-muted">100% - 300%</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Focus Area</label>
                                <select id="focus-select" class="form-select" onchange="updateCrop()">
                                    <option value="center">Center</option>
                                    <option value="face">Face (auto-detect)</option>
                                    <option value="north">Top</option>
                                    <option value="south">Bottom</option>
                                    <option value="east">Right</option>
                                    <option value="west">Left</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Horizontal Position</label>
                                <input type="range" 
                                       id="x-position" 
                                       class="crop-slider" 
                                       min="0" 
                                       max="100" 
                                       value="50" 
                                       oninput="updateCrop()">
                                <small class="text-muted">Left - Right</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Vertical Position</label>
                                <input type="range" 
                                       id="y-position" 
                                       class="crop-slider" 
                                       min="0" 
                                       max="100" 
                                       value="50" 
                                       oninput="updateCrop()">
                                <small class="text-muted">Top - Bottom</small>
                            </div>
                        </div>
                        
                        <!-- Crop Preview -->
                        <div class="crop-preview-container">
                            <div class="crop-preview" id="crop-preview" style="display: none;">
                                <img src="" alt="Crop Preview" id="crop-preview-img">
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button type="button" class="btn btn-success btn-sm" onclick="applyCrop()">
                                <i class="fas fa-check"></i> Apply Changes
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="cancelCrop()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="resetCrop()">
                                <i class="fas fa-undo"></i> Reset to Original
                            </button>
                        </div>
                    </div>
                </div>
                
                {% endif %}
                
                <!-- Rest of form fields -->
                {% crispy form form.helper %}
            </form>
        </div>
    </div>
    
    {% if profile_type == 'Administrator' %}
    <!-- Photo Preview Modal -->
    <div class="modal fade" id="photoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Profile Photo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="" alt="Profile Photo" class="img-fluid rounded" id="modal-photo">
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Missing Fields Summary - ONLY show for non-admin users -->
    {% if missing_fields and not user.is_superuser %}
    <div class="card shadow-sm mt-4 border-info">
        <div class="card-header bg-info bg-opacity-10">
            <h6 class="mb-0 text-info-emphasis">
                <i class="bi bi-info-circle"></i> Missing Information Summary
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% for section, fields in missing_fields.items %}
                <div class="col-md-6 mb-3">
                    <h6 class="fw-bold text-secondary">{{ section }}</h6>
                    <ul class="list-unstyled small text-muted">
                        {% for field in fields %}
                            <li><i class="bi bi-dash"></i> {{ field|title }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>
            {% if profile_type != 'Administrator' %}
            <div class="mt-3">
                <a href="{% if profile_type == 'Broker' %}{% url 'quick_broker_profile_update' %}{% elif profile_type == 'Property Owner' %}{% url 'quick_owner_profile_update' %}{% else %}{% url 'quick_staff_profile_update' %}{% endif %}" 
                   class="btn btn-outline-info btn-sm">
                    <i class="bi bi-lightning"></i> Quick Update Missing Fields
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Navigation Links - Only show for non-administrators -->
    {% if profile_type != 'Administrator' %}
    <div class="row mt-4">
        <div class="col-12 d-flex justify-content-between">
            <a href="{% if profile_type == 'Broker' %}{% url 'broker_dashboard' %}{% elif profile_type == 'Property Owner' %}{% url 'owner_dashboard' %}{% else %}{% url 'staff_dashboard' %}{% endif %}" 
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            
            {% if profile_type == 'Broker' %}
                <a href="{% url 'quick_broker_profile_update' %}" class="btn btn-warning">
                    <i class="bi bi-lightning"></i> Quick Update
                </a>
            {% elif profile_type == 'Property Owner' %}
                <a href="{% url 'quick_owner_profile_update' %}" class="btn btn-warning">
                    <i class="bi bi-lightning"></i> Quick Update
                </a>
            {% else %}
                <a href="{% url 'quick_staff_profile_update' %}" class="btn btn-warning">
                    <i class="bi bi-lightning"></i> Quick Update
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Highlight form fields based on their state
    function highlightFormFields() {
        // Debug: Check what elements actually exist
        console.log('=== DEBUGGING FORM FIELDS ===');
        console.log('All inputs:', document.querySelectorAll('input').length);
        console.log('All textareas:', document.querySelectorAll('textarea').length);
        console.log('All .form-control:', document.querySelectorAll('.form-control').length);
        console.log('All forms:', document.querySelectorAll('form').length);
        console.log('Forms with admin-profile-form class:', document.querySelectorAll('form.admin-profile-form').length);
        console.log('Admin form inputs:', document.querySelectorAll('.admin-profile-form input').length);
        console.log('Form control in admin form:', document.querySelectorAll('.admin-profile-form .form-control').length);
        
        // Try different selectors
        let formFields = document.querySelectorAll('form.admin-profile-form input.form-control, form.admin-profile-form textarea.form-control, form.admin-profile-form select.form-control');
        console.log('Original selector found:', formFields.length);
        
        if (formFields.length === 0) {
            // Try broader selectors
            formFields = document.querySelectorAll('.admin-profile-form input, .admin-profile-form textarea');
            console.log('Broader selector (.admin-profile-form input/textarea):', formFields.length);
        }
        
        if (formFields.length === 0) {
            // Use the form controls that actually exist
            formFields = document.querySelectorAll('.form-control');
            console.log('Form controls found:', formFields.length);
        }
        
        console.log('Using', formFields.length, 'form fields for highlighting');
        
        formFields.forEach(function(field) {
            // Function to check and update field state
            function updateFieldState() {
                // Remove all state classes first
                field.classList.remove('has-data', 'is-empty-required');
                
                if (field.value && field.value.trim() !== '') {
                    // Field has data - no highlighting needed
                    console.log('Field with data (no highlighting):', field.name);
                } else if (field.hasAttribute('required') || 
                          field.name === 'first_name' || 
                          field.name === 'last_name' || 
                          field.name === 'position' || 
                          field.name === 'phone_number' || 
                          field.name === 'bio') {
                    // Empty important field - subtle yellow highlighting
                    field.classList.add('is-empty-required');
                    console.log('Empty important field highlighted:', field.name);
                } else {
                    console.log('Field with no highlighting needed:', field.name);
                }
            }
            
            // Check initial state
            updateFieldState();
            
            // Add event listeners for dynamic updates
            field.addEventListener('input', updateFieldState);
            field.addEventListener('change', updateFieldState);
            field.addEventListener('blur', updateFieldState);
        });
    }
    
    // Highlight profile photo section if no photo uploaded
    function highlightProfilePhoto() {
        const photoSection = document.querySelector('.profile-photo-section');
        const profilePhotoImg = document.querySelector('#photo-preview');
        const photoPlaceholder = document.querySelector('#photo-placeholder');
        
        if (photoSection) {
            // Check if there's no profile photo (either no img element or only placeholder)
            const hasPhoto = profilePhotoImg && !photoPlaceholder;
            
            if (!hasPhoto) {
                photoSection.classList.add('is-empty-photo');
                console.log('Profile photo section highlighted - no photo uploaded');
            } else {
                photoSection.classList.remove('is-empty-photo');
                console.log('Profile photo section normal - photo exists');
            }
        }
    }
    
    // Call highlighting functions after a small delay to ensure DOM is ready
    setTimeout(function() {
        highlightFormFields();
        highlightProfilePhoto();
        console.log('Form field highlighting initialized');
    }, 100);
    
    // Auto-focus on first empty required field
    const requiredFields = document.querySelectorAll('input[required], select[required], textarea[required]');
    for (let field of requiredFields) {
        if (!field.value) {
            field.focus();
            break;
        }
    }
    
    // Form validation feedback
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const requiredEmpty = Array.from(requiredFields).filter(field => !field.value);
            if (requiredEmpty.length > 0) {
                e.preventDefault();
                alert(`Please fill in all required fields. ${requiredEmpty.length} field(s) still need attention.`);
                requiredEmpty[0].focus();
            }
        });
    }
    
    // Photo upload preview
    const photoInput = document.getElementById('id_profile_photo');
    if (photoInput) {
        photoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!validTypes.includes(file.type)) {
                    alert('Please select a valid image file (JPG, PNG, or GIF).');
                    this.value = '';
                    return;
                }
                
                // Validate file size (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB.');
                    this.value = '';
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('photo-preview');
                    const placeholder = document.getElementById('photo-placeholder');
                    
                    if (placeholder) {
                        // Replace placeholder with image
                        placeholder.innerHTML = `
                            <img src="${e.target.result}" 
                                 alt="Profile Photo" 
                                 class="rounded-circle border border-2 border-warning" 
                                 width="120" 
                                 height="120" 
                                 style="object-fit: cover;"
                                 id="photo-preview">
                            <div class="delete-photo-btn" onclick="removePhoto()" title="Remove photo">
                                <i class="fas fa-times"></i>
                            </div>
                        `;
                        placeholder.classList.remove('bg-light', 'border-secondary');
                        placeholder.classList.add('position-relative');
                    } else if (preview) {
                        // Update existing image
                        preview.src = e.target.result;
                    }
                    
                    // Update upload button text and show crop/preview buttons
                    const uploadBtn = document.querySelector('button[onclick*="id_profile_photo"]');
                    const cropBtn = document.getElementById('crop-btn');
                    const previewBtn = document.getElementById('preview-btn');
                    
                    if (uploadBtn) {
                        uploadBtn.innerHTML = '<i class="fas fa-camera"></i> Change Photo';
                    }
                    if (cropBtn) {
                        cropBtn.style.display = 'inline-block';
                    }
                    if (previewBtn) {
                        previewBtn.style.display = 'inline-block';
                    }
                    
                    // Store original image for cropping
                    window.originalImageSrc = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

function removePhoto() {
    if (confirm('Are you sure you want to remove your profile photo?')) {
        // Clear file input
        const photoInput = document.getElementById('id_profile_photo');
        if (photoInput) {
            photoInput.value = '';
        }
        
        // Reset to placeholder
        const container = document.querySelector('.profile-photo-container');
        if (container) {
            container.innerHTML = `
                <div class="bg-light rounded-circle border border-2 border-secondary d-flex align-items-center justify-content-center" 
                     style="width: 120px; height: 120px;"
                     id="photo-placeholder">
                    <i class="fas fa-user fa-3x text-muted"></i>
                </div>
            `;
        }
        
        // Update button text
        const uploadBtn = document.querySelector('button[onclick*="id_profile_photo"]');
        if (uploadBtn) {
            uploadBtn.innerHTML = '<i class="fas fa-camera"></i> Upload Photo';
        }
    }
}

function previewPhoto() {
    const preview = document.getElementById('photo-preview');
    const modalPhoto = document.getElementById('modal-photo');
    
    if (preview && modalPhoto) {
        modalPhoto.src = preview.src;
        const modal = new bootstrap.Modal(document.getElementById('photoModal'));
        modal.show();
    }
}

// Crop and Zoom Functions
function showCropControls() {
    const cropControls = document.getElementById('crop-controls');
    const cropPreview = document.getElementById('crop-preview');
    
    if (cropControls) {
        cropControls.style.display = 'block';
        cropPreview.style.display = 'block';
        
        // Set original image source if not already set
        if (!window.originalImageSrc) {
            const preview = document.getElementById('photo-preview');
            if (preview && preview.src) {
                window.originalImageSrc = preview.src;
            }
        }
        
        // Initialize crop preview with original image
        updateCrop();
        
        // Scroll to crop controls
        cropControls.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function updateCrop() {
    const preview = document.getElementById('photo-preview');
    const cropPreviewImg = document.getElementById('crop-preview-img');
    
    if (!preview || !cropPreviewImg || !window.originalImageSrc) return;
    
    // Get current crop settings
    const zoom = document.getElementById('zoom-slider').value;
    const focus = document.getElementById('focus-select').value;
    const xPos = document.getElementById('x-position').value;
    const yPos = document.getElementById('y-position').value;
    
    // Build Cloudinary transformation URL
    // For demo purposes, we'll use a simple preview with CSS transforms
    // In production, you'd use Cloudinary's transformation API
    
    // Calculate crop parameters
    const scale = zoom / 100;
    const translateX = (50 - xPos) * 2; // Convert 0-100 to -100 to 100
    const translateY = (50 - yPos) * 2;
    
    // Apply transformations to preview
    cropPreviewImg.src = window.originalImageSrc;
    cropPreviewImg.style.transform = `scale(${scale}) translate(${translateX}%, ${translateY}%)`;
    cropPreviewImg.style.transformOrigin = 'center center';
    
    // Store crop data for form submission
    const cropData = {
        zoom: zoom,
        focus: focus,
        x: xPos,
        y: yPos,
        transformation: `c_crop,g_${focus},w_400,h_400,z_${zoom/100}`
    };
    
    document.getElementById('crop-data').value = JSON.stringify(cropData);
}

function applyCrop() {
    const cropData = document.getElementById('crop-data').value;
    const preview = document.getElementById('photo-preview');
    const cropPreviewImg = document.getElementById('crop-preview-img');
    
    if (cropData && preview && cropPreviewImg) {
        // Apply the cropped preview to main preview
        preview.src = cropPreviewImg.src;
        preview.style.transform = cropPreviewImg.style.transform;
        preview.style.transformOrigin = cropPreviewImg.style.transformOrigin;
        
        // Hide crop controls
        cancelCrop();
        
        // Show success message
        showToast('Crop settings applied! Save the form to finalize changes.', 'success');
    }
}

function cancelCrop() {
    const cropControls = document.getElementById('crop-controls');
    if (cropControls) {
        cropControls.style.display = 'none';
    }
}

function resetCrop() {
    // Reset all crop controls to default values
    document.getElementById('zoom-slider').value = 100;
    document.getElementById('focus-select').value = 'center';
    document.getElementById('x-position').value = 50;
    document.getElementById('y-position').value = 50;
    document.getElementById('crop-data').value = '';
    
    // Reset preview
    const preview = document.getElementById('photo-preview');
    if (preview && window.originalImageSrc) {
        preview.src = window.originalImageSrc;
        preview.style.transform = '';
        preview.style.transformOrigin = '';
    }
    
    updateCrop();
    showToast('Crop settings reset to original.', 'info');
}

function showToast(message, type = 'info') {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 4000);
}
</script>

{% endblock %}

{% block extra_js %}
    {{ form.media.js }}
    <script src="{% static 'js/forms.js' %}"></script>
    <!-- Universal Image Cropper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="{% static 'js/image-cropper.js' %}"></script>
    <script>
        // Set Cloudinary configuration globally
        window.CLOUDINARY_CLOUD_NAME = '{{ CLOUDINARY_CLOUD_NAME }}';
        window.CLOUDINARY_UPLOAD_PRESET = '{{ CLOUDINARY_UPLOAD_PRESET }}';
        
        // Setup universal image cropper for profile photo when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setupImageCropper(
                '#id_profile_photo', 
                '.profile-photo-container', 
                '#photo-crop-data',
                {
                    aspectRatio: 1, // Square for profile photos
                    modalTitle: 'Crop Your Profile Photo',
                    cropButtonText: 'Crop & Zoom',
                    outputWidth: 400,
                    outputHeight: 400,
                    onUpload: function(file, imageSrc) {
                        // Update existing photo handling logic if needed
                        console.log('Profile photo uploaded:', file.name);
                    }
                }
            );
        });
    </script>
{% endblock %}