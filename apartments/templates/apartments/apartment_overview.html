{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .carousel-item img {
        height: 500px;
        object-fit: cover;
        border-radius: 12px;
    }
    .sticky-sidebar {
        position: sticky;
        top: 90px;
    }
    .amenity-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        border-radius: 50px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header / Title -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="fw-bold mb-1">{{ apartment.building.name }} â€“ Unit {{ apartment.unit_number }}</h1>
            <p class="text-muted fs-5 mb-0">
                <i class="fas fa-map-marker-alt me-2"></i>{{ apartment.building.street_address_1 }}, {{ apartment.building.city }}
                {% if apartment.building.neighborhood %}
                    <span class="badge bg-secondary ms-2">{{ apartment.building.neighborhood }}</span>
                {% endif %}
            </p>
        </div>
        
        <!-- Actions -->
        <div class="d-flex gap-2">
            <button class="btn btn-outline-warning save-overview-btn" onclick="toggleOverviewSave({{ apartment.id }})">
                <i class="far fa-heart me-2" id="overview-heart-{{ apartment.id }}"></i>
                <span id="save-text-{{ apartment.id }}">Save</span>
            </button>
            {% if user.is_authenticated and user.is_broker or user.is_superuser %}
                <a href="{% url 'create_application' apartment.id %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Apply
                </a>
                <a href="{% url 'apartment_detail' apartment.id %}" class="btn btn-outline-dark">
                    <i class="fas fa-edit"></i>
                </a>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Content (Left) -->
        <div class="col-lg-8">
            <!-- Image Carousel -->
            {% if apartment.images.all %}
                <div id="apartmentCarousel" class="carousel slide mb-4 shadow-sm rounded-3 overflow-hidden" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        {% for image in apartment.images.all %}
                            <button type="button" data-bs-target="#apartmentCarousel" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active"{% endif %}></button>
                        {% endfor %}
                    </div>
                    <div class="carousel-inner">
                        {% for image in apartment.images.all %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ image.large_url }}" class="d-block w-100" alt="Apartment Image">
                            </div>
                        {% endfor %}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#apartmentCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#apartmentCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            {% else %}
                <div class="alert alert-warning mb-4">
                    <i class="fas fa-camera me-2"></i>No images available for this apartment.
                </div>
            {% endif %}

            <!-- Key Features Grid -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Overview</h5>
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <i class="fas fa-dollar-sign fa-lg text-success mb-2"></i>
                                <div class="small text-muted">Rent</div>
                                <div class="fw-bold">${{ apartment.rent_price|floatformat:0 }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <i class="fas fa-bed fa-lg text-primary mb-2"></i>
                                <div class="small text-muted">Bedrooms</div>
                                <div class="fw-bold">{% if apartment.bedrooms == 0 %}Studio{% else %}{{ apartment.bedrooms|floatformat:0 }}{% endif %}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <i class="fas fa-bath fa-lg text-info mb-2"></i>
                                <div class="small text-muted">Bathrooms</div>
                                <div class="fw-bold">{{ apartment.bathrooms|floatformat:0 }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <i class="fas fa-ruler-combined fa-lg text-warning mb-2"></i>
                                <div class="small text-muted">Square Feet</div>
                                <div class="fw-bold">{{ apartment.square_feet|default:"N/A" }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            {% if apartment.description %}
            <div class="mb-4">
                <h5 class="fw-bold mb-3">Description</h5>
                <div class="p-4 bg-light rounded-3">
                    {{ apartment.description|safe }}
                </div>
            </div>
            {% endif %}

            <!-- Amenities -->
            <div class="mb-4">
                <h5 class="fw-bold mb-3">Amenities</h5>
                <div class="d-flex flex-wrap gap-2">
                    {% for amenity in apartment.amenities.all %}
                        <span class="badge bg-light text-dark border amenity-badge">
                            <i class="fas fa-check text-success me-2"></i>{{ amenity.name }}
                        </span>
                    {% empty %}
                        <p class="text-muted">No specific amenities listed.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Required Documents -->
            {% if apartment.required_documents %}
            <div class="mb-4">
                <h5 class="fw-bold mb-3">Required Documents</h5>
                <div class="alert alert-info border-0 shadow-sm">
                    {{ apartment.required_documents|safe }}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar (Right) -->
        <div class="col-lg-4">
            <div class="sticky-sidebar">
                <!-- Broker Card -->
                {% if apartment.building.brokers.exists %}
                    {% with broker=apartment.building.brokers.first %}
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body text-center pt-4">
                            {% if broker.broker_profile and broker.broker_profile.profile_photo %}
                                <img src="{{ broker.broker_profile.profile_photo.url }}" class="rounded-circle mb-3 shadow-sm" style="width: 100px; height: 100px; object-fit: cover;" alt="Broker">
                            {% else %}
                                <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center mb-3 shadow-sm" style="width: 100px; height: 100px;">
                                    <i class="fas fa-user-tie fa-3x text-muted"></i>
                                </div>
                            {% endif %}
                            
                            <h5 class="fw-bold mb-1">
                                {% if broker.broker_profile %}
                                    {{ broker.broker_profile.first_name }} {{ broker.broker_profile.last_name }}
                                {% else %}
                                    {{ broker.email }}
                                {% endif %}
                            </h5>
                            <p class="text-muted small mb-3">Licensed Real Estate Broker</p>
                            
                            {% if broker.broker_profile.bio %}
                                <p class="small text-muted mb-3">{{ broker.broker_profile.bio|truncatewords:20 }}</p>
                            {% endif %}
                            
                            <div class="d-grid gap-2">
                                <a href="#broker-contact" class="btn btn-dark rounded-pill">Contact Broker</a>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% endif %}

                <!-- Contact Form -->
                <div class="card border-0 shadow-sm" id="broker-contact">
                    <div class="card-header bg-white border-0 pt-4 pb-0">
                        <h5 class="fw-bold mb-0">Contact Agent</h5>
                    </div>
                    <div class="card-body">
                        <form id="brokerContactForm" method="post" action="{% url 'contact_broker' apartment.id %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Name</label>
                                <input type="text" class="form-control" name="name" value="{% if user.is_authenticated %}{{ user.applicant_profile.first_name }} {{ user.applicant_profile.last_name }}{% endif %}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Email</label>
                                <input type="email" class="form-control" name="email" value="{% if user.is_authenticated %}{{ user.email }}{% endif %}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Phone</label>
                                <input type="tel" class="form-control" name="phone" value="{% if user.is_authenticated %}{{ user.applicant_profile.phone_number }}{% endif %}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label small fw-bold">I'm interested in...</label>
                                <select class="form-select" id="contact_type" name="contact_type" required>
                                    <option value="request_tour">Scheduling a Tour</option>
                                    <option value="ask_question">Asking a Question</option>
                                </select>
                            </div>

                            <!-- Dynamic Fields -->
                            <div id="tour_fields" class="mb-3">
                                <label class="form-label small fw-bold">Preferred Time</label>
                                <input type="datetime-local" class="form-control" name="preferred_datetime_1">
                            </div>

                            <div id="question_fields" class="mb-3" style="display:none;">
                                <label class="form-label small fw-bold">Message</label>
                                <textarea class="form-control" name="question" rows="3" placeholder="Hi, I'm interested in this apartment..."></textarea>
                            </div>

                            <button type="submit" class="btn btn-warning w-100 fw-bold rounded-pill" style="background-color: #ffcc00; border: none;">
                                Send Message
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contactType = document.getElementById('contact_type');
    const tourFields = document.getElementById('tour_fields');
    const questionFields = document.getElementById('question_fields');
    
    if(contactType){
        contactType.addEventListener('change', function() {
            if (this.value === 'request_tour') {
                tourFields.style.display = 'block';
                questionFields.style.display = 'none';
            } else {
                tourFields.style.display = 'none';
                questionFields.style.display = 'block';
            }
        });
    }
});

function toggleOverviewSave(apartmentId) {
    // Basic toggle implementation for UI feedback
    const btn = document.querySelector('.save-overview-btn');
    const icon = document.getElementById(`overview-heart-${apartmentId}`);
    const text = document.getElementById(`save-text-${apartmentId}`);
    
    if (icon.classList.contains('far')) {
        icon.classList.replace('far', 'fas');
        text.textContent = 'Saved';
        btn.classList.add('btn-warning');
        btn.classList.remove('btn-outline-warning');
    } else {
        icon.classList.replace('fas', 'far');
        text.textContent = 'Save';
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-outline-warning');
    }
    // Actual API call would go here
}
</script>
{% endblock %}
