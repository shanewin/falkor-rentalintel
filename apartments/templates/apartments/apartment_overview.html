{% extends 'base.html' %}
{% load static %}
{% load apartment_extras %}

{% block extra_css %}
<link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet'>
<link rel="stylesheet" href="{% static 'apartments/css/apartments.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header / Title -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="fw-bold mb-1">{{ apartment.building.name }} – Unit {{ apartment.unit_number }}</h1>
            <p class="text-muted fs-5 mb-0">
                <i class="fas fa-map-marker-alt me-2"></i>{{ apartment.building.street_address_1 }}, {{ apartment.building.city }}
                {% if apartment.building.neighborhood %}
                    <span class="badge bg-secondary ms-2">{{ apartment.building.neighborhood }}</span>
                {% endif %}
            </p>
        </div>
        
        <!-- Actions -->
        <div class="d-flex gap-2">
            <button class="btn {% if is_saved %}btn-warning{% else %}btn-outline-warning{% endif %} save-overview-btn" onclick="toggleOverviewSave({{ apartment.id }})">
                <i class="{% if is_saved %}fas{% else %}far{% endif %} fa-heart me-2" id="overview-heart-{{ apartment.id }}"></i>
                <span id="save-text-{{ apartment.id }}">{% if is_saved %}Saved{% else %}Save{% endif %}</span>
            </button>
            {% if user.is_authenticated and user.is_broker or user.is_superuser %}
                <a href="{% url 'create_application' apartment.id %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Apply
                </a>
                <a href="{% url 'apartment_edit' apartment.id %}" class="btn btn-outline-dark">
                    <i class="fas fa-edit"></i>
                </a>
            {% endif %}
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Content (Left) -->
        <div class="col-lg-8">
            <!-- Image Carousel -->
            {% with all_images=apartment.all_images fallback_img=apartment.id|get_fallback_image %}
            {% if all_images %}
                <div id="apartmentCarousel" class="carousel slide mb-4 shadow-sm rounded-3 overflow-hidden" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        {% for image in all_images %}
                            <button type="button" data-bs-target="#apartmentCarousel" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active"{% endif %}></button>
                        {% endfor %}
                    </div>
                    <div class="carousel-inner">
                        {% for image in all_images %}
                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                <img src="{{ image.large_url }}" class="d-block w-100" alt="Apartment Image"
                                     onerror="this.src='{{ fallback_img }}';this.onerror=null;">
                            </div>
                        {% endfor %}
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#apartmentCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#apartmentCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            {% else %}
                <div class="text-center mb-4">
                    <img src="{{ fallback_img }}" class="img-fluid rounded-3 shadow-sm" alt="Image Coming Soon" style="height: 500px; width: 100%; object-fit: cover;">
                    <div class="alert alert-warning mt-2">
                        <i class="fas fa-camera me-2"></i>No direct images available for this apartment. Showing placeholders.
                    </div>
                </div>
            {% endif %}
            {% endwith %}

            <!-- Key Features Grid -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3">Overview</h5>
                    <div class="row g-3">
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <i class="fas fa-dollar-sign fa-lg text-dark mb-2"></i>
                                <div class="small text-muted">Rent</div>
                                <div class="fw-bold">${{ apartment.rent_price|floatformat:0 }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <i class="fas fa-bed fa-lg text-dark mb-2"></i>
                                <div class="small text-muted">Bedrooms</div>
                                <div class="fw-bold">{% if apartment.bedrooms == 0 %}Studio{% else %}{{ apartment.bedrooms|floatformat:0 }}{% endif %}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <i class="fas fa-bath fa-lg text-dark mb-2"></i>
                                <div class="small text-muted">Bathrooms</div>
                                <div class="fw-bold">{{ apartment.bathrooms|floatformat:0 }}</div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="p-3 bg-light rounded text-center">
                                <i class="fas fa-ruler-combined fa-lg text-dark mb-2"></i>
                                <div class="small text-muted">Square Feet</div>
                                <div class="fw-bold">{{ apartment.square_feet|default:"N/A" }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            {% if apartment.description %}
            <div class="mb-4">
                <h5 class="fw-bold mb-3">Description</h5>
                <div class="p-4 bg-light rounded-3">
                    {{ apartment.description|safe }}
                </div>
            </div>
            {% endif %}

            <!-- Amenities -->
            <div class="mb-4">
                <h5 class="fw-bold mb-3">Amenities</h5>
                <div class="d-flex flex-wrap gap-2">
                    {% for amenity in apartment.amenities.all %}
                        <span class="badge bg-light text-dark border amenity-badge">
                            <i class="fas {{ amenity.icon }} text-success me-2"></i>{{ amenity.name }}
                        </span>
                    {% empty %}
                        <p class="text-muted">No specific amenities listed.</p>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Neighborhood & Lifestyle -->
            <div class="mb-5">
                <hr class="my-5">
                <h4 class="fw-bold mb-4">Neighborhood & Lifestyle</h4>
                
                {% if apartment.building.walk_score or apartment.building.bike_score or apartment.building.transit_score %}
                <div class="row mb-5">
                    <div class="col-12">
                        <h6 class="text-uppercase fw-bold text-muted mb-4 small">Getting Around</h6>
                        <div class="d-flex flex-wrap gap-5">
                            {% if apartment.building.walk_score %}
                            <div class="score-item">
                                <div class="score-circle">{{ apartment.building.walk_score }}</div>
                                <div class="score-label">Walk Score®</div>
                                <div class="score-desc text-nowrap">{{ apartment.building.walk_description }}</div>
                            </div>
                            {% endif %}
                            
                            {% if apartment.building.bike_score %}
                            <div class="score-item">
                                <div class="score-circle">{{ apartment.building.bike_score }}</div>
                                <div class="score-label">Bike Score®</div>
                                <div class="score-desc text-nowrap">{{ apartment.building.bike_description }}</div>
                            </div>
                            {% endif %}

                            {% if apartment.building.transit_score %}
                            <div class="score-item">
                                <div class="score-circle">{{ apartment.building.transit_score }}</div>
                                <div class="score-label">Transit Score®</div>
                                <div class="score-desc text-nowrap">{{ apartment.building.transit_description }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Nearby Schools -->
                {% if apartment.building.nearby_schools.exists %}
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-uppercase fw-bold text-muted mb-4 small">Nearby Schools</h6>
                        <div class="list-group list-group-flush border-top border-bottom">
                            {% for school in apartment.building.nearby_schools.all %}
                            <div class="list-group-item px-0 py-3 border-light">
                                <div class="d-flex align-items-center">
                                    <div class="school-rating me-3 {% if school.rating >= 8 %}rating-high{% elif school.rating >= 5 %}rating-mid{% else %}rating-low{% endif %}">
                                        {{ school.rating|default:"?" }}
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="fw-bold mb-0">{{ school.name }}</h6>
                                                <p class="mb-0 small text-muted">Grades: {{ school.grades }} • {{ school.school_type }}</p>
                                            </div>
                                            <div class="text-end">
                                                <span class="fw-bold">{{ school.distance }} mi</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <p class="text-muted extra-small mt-2" style="font-size: 0.75rem;">School data provided by GreatSchools API.</p>
                    </div>
                </div>
                {% endif %}

                {% if not apartment.building.walk_score and not apartment.building.nearby_schools.exists %}
                <div class="alert alert-light border text-center py-4">
                    <i class="fas fa-map-marked-alt fa-2x text-muted mb-3 d-block"></i>
                    <p class="mb-1 text-muted">Neighborhood data is being gathered for this property.</p>
                </div>
                {% endif %}
            </div>

            <!-- Location Map -->
            <div class="mb-5">
                <hr class="my-5">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold mb-0">Location</h4>
                    <span class="text-muted small"><i class="fas fa-map-marker-alt me-1"></i>{{ apartment.building.street_address_1 }}</span>
                </div>
                <div class="shadow-sm rounded-3 overflow-hidden border">
                    <div id="map"></div>
                </div>
            </div>

            <!-- Travel Times -->
            <div class="mb-5" id="travel-times-section">
                <h4 class="fw-bold mb-4">Travel Times</h4>
                
                <div class="travel-times-container">
                    <!-- Transport Mode Toggle -->
                    <div class="transport-toggle">
                        <button class="transport-btn active" data-mode="driving">
                            <i class="fas fa-car me-2"></i>Car
                        </button>
                        <button class="transport-btn" data-mode="walking">
                            <i class="fas fa-walking me-2"></i>Walk
                        </button>
                        <button class="transport-btn" data-mode="cycling">
                            <i class="fas fa-bicycle me-2"></i>Bike
                        </button>
                    </div>

                    <!-- Search Box -->
                    <div class="search-input-group mb-4">
                        <i class="fas fa-search"></i>
                        <input type="text" id="destination-search" class="form-control" placeholder="Add a destination (e.g. Work or Gym)">
                        <div id="search-results" class="list-group position-absolute w-100 shadow-sm" style="z-index: 1000; display: none;"></div>
                    </div>

                    <!-- Destination List -->
                    <div id="destinations-list">
                        <!-- Items injected by JS -->
                    </div>

                    <div id="no-destinations" class="text-center py-4 bg-light rounded-3">
                        <p class="text-muted mb-0 small">Enter an address to see commute times from this apartment.</p>
                    </div>
                </div>
            </div>

            <!-- Required Documents -->
            {% if apartment.required_documents %}
            <div class="mb-4">
                <h5 class="fw-bold mb-3">Required Documents</h5>
                <div class="alert alert-info border-0 shadow-sm">
                    {{ apartment.required_documents|safe }}
                </div>
            </div>
            {% endif %}
        </div>

                <!-- Sidebar (Right) -->
        <div class="col-lg-4">
            <div class="sticky-sidebar">
                
                {% if user.is_authenticated and user.is_broker or user.is_superuser %}
                <!-- BROKER VIEW: Smart Matches -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-4">
                            <div class="icon-box bg-primary-subtle text-primary rounded-circle me-3">
                                <i class="bi bi-person-check fs-4"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-1 fw-bold">Smart Matches</h5>
                                <p class="text-muted small mb-0">Qualified applicants for this unit</p>
                            </div>
                        </div>

                        {% if smart_matches %}
                            <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                                {% for match in smart_matches %}
                                <a href="{% url 'applicant_overview' match.applicant.id %}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center px-0 py-3">
                                    <div class="d-flex align-items-center">
                                        <!-- Score Badge -->
                                        <div class="me-3 text-center" style="width: 45px;">
                                            {% if match.match_percentage >= 80 %}
                                                <span class="badge bg-success rounded-pill w-100">{{ match.match_percentage }}%</span>
                                            {% elif match.match_percentage >= 60 %}
                                                <span class="badge bg-warning text-dark rounded-pill w-100">{{ match.match_percentage }}%</span>
                                            {% else %}
                                                <span class="badge bg-secondary rounded-pill w-100">{{ match.match_percentage }}%</span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Applicant Info -->
                                        <div>
                                            <h6 class="mb-0 text-dark">{{ match.applicant.first_name }} {{ match.applicant.last_name|slice:":1" }}.</h6>
                                            <small class="text-muted">
                                                {% if match.applicant.desired_move_in_date %}
                                                Move-in: {{ match.applicant.desired_move_in_date|date:"M d" }}
                                                {% else %}
                                                Flexible Move-in
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                    <i class="bi bi-chevron-right text-muted small"></i>
                                </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-search display-6 mb-3 d-block opacity-50"></i>
                                <p class="mb-0">No matching applicants found yet.</p>
                                <small>Matches appear when applicants favor this neighborhood.</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                {% else %}
                <!-- APPLICANT VIEW: Broker Card & Contact Form -->
                
                <!-- Broker Card -->
                {% if apartment.building.brokers.exists %}
                    {% with broker=apartment.building.brokers.first %}
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4 text-center">
                            <a href="{% url 'public_broker_profile' broker.id %}" class="text-decoration-none text-dark">
                                {% if broker.broker_profile.profile_picture %}
                                    <img src="{{ broker.broker_profile.profile_picture.url }}" alt="{{ broker.get_full_name }}" 
                                         class="rounded-circle mb-3 object-fit-cover shadow-sm" width="80" height="80">
                                {% else %}
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto mb-3 shadow-sm" 
                                         style="width: 80px; height: 80px;">
                                        <span class="fs-4 text-secondary">{{ broker.first_name|first }}{{ broker.last_name|first }}</span>
                                    </div>
                                {% endif %}
                                
                                <h5 class="fw-bold mb-1">{{ broker.get_full_name }}</h5>
                            <p class="text-muted small mb-3">Licensed Real Estate Broker</p>
                            </a>
                            
                            <div class="d-flex flex-column gap-1">
                                <!-- Phone -->
                                <div class="broker-contact-row">
                                    <div class="broker-contact-text">
                                        <span class="fw-bold">Phone:</span> {{ broker.phone_number|format_phone }}
                                    </div>
                                    <button type="button" class="broker-copy-btn text-muted" onclick="copyToClipboard('{{ broker.phone_number|format_phone }}')" title="Copy Phone">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>

                                <!-- Email -->
                                <div class="broker-contact-row">
                                    <div class="broker-contact-text">
                                        <span class="fw-bold">Email:</span> {{ broker.email }}
                                    </div>
                                    <button type="button" class="broker-copy-btn text-muted" onclick="copyToClipboard('{{ broker.email }}')" title="Copy Email">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                
                                <!-- View Profile -->
                                <a href="{% url 'public_broker_profile' broker.id %}" class="btn btn-light btn-sm text-muted mt-3">
                                    View Full Profile
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% endif %}

                <!-- Contact Form -->
                <div class="card border-0 shadow-sm" id="broker-contact">
                    <div class="card-body p-4">
                        {% if has_contacted %}
                            <div class="alert alert-success mb-4 d-flex align-items-center">
                                <i class="fas fa-check-circle fs-4 me-3"></i>
                                <div>
                                    <strong>Message Sent!</strong><br>
                                    <small>You have already contacted the broker about this apartment.</small>
                                </div>
                            </div>
                        {% endif %}
                        <form method="post" action="{% url 'contact_broker' apartment.id %}">
                            {% csrf_token %}
                            
                            <!-- Contact Type -->
                            <div class="mb-3">
                                <label class="form-label small fw-bold">I'm interested in...</label>
                                <select class="form-select form-select-sm select2" id="contact_type" name="contact_type" required>
                                    <option value="request_tour">Scheduling a Tour</option>
                                    <option value="ask_question">Asking a Question</option>
                                </select>
                            </div>

                            <!-- Personal Info -->
                            <div class="mb-3">
                                <input type="text" name="name" class="form-control form-control-sm" required placeholder="Full Name" value="{{ request.user.get_full_name }}">
                            </div>
                            <div class="mb-3">
                                <input type="email" name="email" class="form-control form-control-sm" required placeholder="Email" value="{{ request.user.email }}">
                            </div>
                            <div class="mb-3">
                                <input type="tel" name="phone" class="form-control form-control-sm" placeholder="Phone" value="{{ request.user.phone_number }}">
                            </div>

                            <!-- Dynamic Fields -->
                            <div id="tour_fields" class="mb-3">
                                <label class="form-label small text-muted">Tour Type</label>
                                <select class="form-select form-select-sm mb-2 select2" name="tour_type">
                                    <option value="in_person">In-Person</option>
                                    <option value="video_chat">Video Chat</option>
                                </select>
                                
                                <label class="form-label small text-muted">Preferred Time 1</label>
                                <input type="datetime-local" class="form-control form-control-sm mb-2" name="preferred_datetime_1">
                                
                                <label class="form-label small text-muted">Preferred Time 2 (Optional)</label>
                                <input type="datetime-local" class="form-control form-control-sm" name="preferred_datetime_2">
                            </div>

                            <div id="question_fields" class="mb-3" style="display:none;">
                                <label class="form-label small text-muted">Message</label>
                                <textarea name="question" class="form-control form-control-sm" rows="3" placeholder="Hi, I'm interested in this apartment..."></textarea>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">Send Message</button>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted" style="font-size: 0.7rem;">
                                    By sending, you agree to our Terms.
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contactType = document.getElementById('contact_type');
    const tourFields = document.getElementById('tour_fields');
    const questionFields = document.getElementById('question_fields');
    
    if(contactType){
        contactType.addEventListener('change', function() {
            if (this.value === 'request_tour') {
                tourFields.style.display = 'block';
                questionFields.style.display = 'none';
            } else {
                tourFields.style.display = 'none';
                questionFields.style.display = 'block';
            }
        });
    }
});

function toggleOverviewSave(apartmentId) {
    const btn = document.querySelector('.save-overview-btn');
    const icon = document.getElementById(`overview-heart-${apartmentId}`);
    const text = document.getElementById(`save-text-${apartmentId}`);
    
    // Get CSRF token
    let csrftoken = null;
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) {
        csrftoken = csrfInput.value;
    } else {
        // Fallback or handle error
        console.error("CSRF token not found");
        return; 
    }

    fetch('/applicants/api/toggle-saved-apartment/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            'apartment_id': apartmentId
        })
    })
    .then(response => {
        if (response.status === 403) {
            alert("Only applicants can save apartments.");
            return null;
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            if (data.is_saved) {
                icon.classList.replace('far', 'fas');
                text.textContent = 'Saved';
                btn.classList.add('btn-warning');
                btn.classList.remove('btn-outline-warning');
            } else {
                icon.classList.replace('fas', 'far');
                text.textContent = 'Save';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-outline-warning');
            }
        } 
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function copyToClipboard(text) {
    if (!text) return;
    navigator.clipboard.writeText(text).then(function() {
        // Show a small toast or temporary feedback if desired
        // For now we'll just log it or maybe change the icon temporarily
        // But a simple alert is too intrusive
        console.log('Copied to clipboard');
        
        // Improve: Create a temporary toast
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 p-3';
        toast.style.zIndex = '1100';
        toast.innerHTML = `
            <div class="toast show align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        Copied to clipboard!
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 2000);
    }, function(err) {
        console.error('Could not copy text: ', err);
    });
}
</script>
{% endblock %}

{% block extra_js %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
<script src="{% static 'js/forms.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = '{{ mapbox_token }}';
    const originLat = {{ apartment.building.latitude|default:"null" }};
    const originLng = {{ apartment.building.longitude|default:"null" }};
    const price = {{ apartment.rent_price|default:0 }};

    if (!token || !originLat || !originLng) {
        const mapEl = document.getElementById('map');
        if (mapEl) mapEl.innerHTML = '<div class="alert alert-light m-3 text-center py-5"><i class="fas fa-map-marker-alt fa-2x text-muted mb-3 d-block"></i>Map coordinates not available.</div>';
        return;
    }

    // 1. Map Initialization
    mapboxgl.accessToken = token;
    try {
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [originLng, originLat],
            zoom: 15
        });

        map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

        const el = document.createElement('div');
        el.className = 'map-marker';
        el.innerHTML = `<div class="badge bg-dark shadow-sm border border-white p-2">$${Math.floor(price).toLocaleString()}</div>`;

        new mapboxgl.Marker(el)
            .setLngLat([originLng, originLat])
            .addTo(map);

    } catch (e) {
        console.error('Mapbox error:', e);
    }

    // 2. Travel Times Logic
    let currentMode = 'driving';
    let destinations = JSON.parse(localStorage.getItem('doorway_destinations') || '[]');

    const destinationsList = document.getElementById('destinations-list');
    const noDestMsg = document.getElementById('no-destinations');
    const searchInput = document.getElementById('destination-search');
    const resultsPanel = document.getElementById('search-results');

    renderDestinations();

    // Mode Toggle
    document.querySelectorAll('.transport-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.transport-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentMode = this.dataset.mode;
            renderDestinations();
        });
    });

    // Autocomplete
    let searchTimeout;
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value;
            if (query.length < 3) {
                resultsPanel.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${token}&proximity=${originLng},${originLat}&bbox=${originLng-1},${originLat-1},${originLng+1},${originLat+1}`)
                    .then(r => r.json())
                    .then(data => {
                        resultsPanel.innerHTML = '';
                        if (data.features && data.features.length > 0) {
                            data.features.forEach(feature => {
                                const item = document.createElement('button');
                                item.className = 'list-group-item list-group-item-action small py-2';
                                item.textContent = feature.place_name;
                                item.onclick = () => {
                                    addDestination(feature);
                                    resultsPanel.style.display = 'none';
                                    searchInput.value = '';
                                };
                                resultsPanel.appendChild(item);
                            });
                            resultsPanel.style.display = 'block';
                        } else {
                            resultsPanel.style.display = 'none';
                        }
                    });
            }, 300);
        });
    }

    function addDestination(feature) {
        const newDest = {
            id: Date.now(),
            name: feature.text,
            address: feature.place_name,
            lng: feature.center[0],
            lat: feature.center[1]
        };
        destinations.push(newDest);
        localStorage.setItem('doorway_destinations', JSON.stringify(destinations));
        renderDestinations();
    }

    window.removeDestination = function(id) {
        destinations = destinations.filter(d => d.id !== id);
        localStorage.setItem('doorway_destinations', JSON.stringify(destinations));
        renderDestinations();
    };

    function renderDestinations() {
        if (!destinationsList) return;
        if (destinations.length === 0) {
            destinationsList.innerHTML = '';
            if (noDestMsg) noDestMsg.style.display = 'block';
            return;
        }

        if (noDestMsg) noDestMsg.style.display = 'none';
        destinationsList.innerHTML = destinations.map(d => `
            <div class="destination-item" id="dest-${d.id}">
                <div class="dest-icon"><i class="fas fa-location-arrow"></i></div>
                <div class="dest-info">
                    <div class="fw-bold small mb-0">${d.name}</div>
                    <div class="extra-small text-muted" style="font-size: 0.7rem;">${d.address.split(',')[0]}</div>
                </div>
                <div class="dest-time text-end me-3">
                    <span class="loading-spinner small text-muted"><i class="fas fa-spinner fa-spin"></i></span>
                </div>
                <div class="remove-dest" onclick="removeDestination(${d.id})">
                    <i class="fas fa-times"></i>
                </div>
            </div>
        `).join('');

        destinations.forEach(d => updateTime(d));
    }

    function updateTime(dest) {
        const timeEl = document.querySelector(`#dest-${dest.id} .dest-time`);
        if (!timeEl) return;
        
        const coords = `${originLng},${originLat};${dest.lng},${dest.lat}`;
        const profile = currentMode === 'driving' ? 'mapbox/driving' : (currentMode === 'walking' ? 'mapbox/walking' : 'mapbox/cycling');
        
        fetch(`https://api.mapbox.com/directions/v5/${profile}/${coords}?access_token=${token}`)
            .then(r => r.json())
            .then(data => {
                if (data.routes && data.routes[0]) {
                    const minutes = Math.round(data.routes[0].duration / 60);
                    timeEl.innerHTML = `${minutes} <span class="small fw-normal">min</span>`;
                } else {
                    timeEl.innerHTML = '--';
                }
            })
            .catch(() => {
                timeEl.innerHTML = '--';
            });
    }

    document.addEventListener('click', (e) => {
        if (searchInput && resultsPanel && !searchInput.contains(e.target) && !resultsPanel.contains(e.target)) {
            resultsPanel.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
