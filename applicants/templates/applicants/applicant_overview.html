{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/doorway-forms.css' %}">
    <link rel="stylesheet" href="{% static 'applicants/css/applicants.css' %}">
    <style>
        .profile-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        
        .profile-section h3 {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #ffcc00;
            display: flex;
            align-items: center;
        }
        
        .profile-section h3 i {
            margin-right: 0.75rem;
            color: #ffcc00;
            width: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            color: #2c3e50;
            font-size: 1rem;
            line-height: 1.4;
        }
        
        .employment-card, .asset-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .employment-card:hover, .asset-card:hover {
            border-color: #ffcc00;
            box-shadow: 0 2px 8px rgba(255, 204, 0, 0.1);
        }
        
        .employment-card h4, .asset-card h4 {
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .pet-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .pet-card:hover {
            border-color: #ffcc00;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .address-card {
            background: #f8f9fa;
            border-left: 4px solid #ffcc00;
            padding: 1.25rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 1rem;
        }
        
        .profile-photo-container {
            position: relative;
            display: inline-block;
        }
        
        .profile-photo {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #ffcc00;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
                margin-top: 1rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div>
                <h1>{{ applicant.first_name }} {{ applicant.last_name }}</h1>
                <p class="mb-0">Applicant Profile Overview</p>
            </div>
            <div class="header-actions">
                <a href="{% url 'profile_step1' %}" class="btn btn-primary">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </a>
                <a href="{% url 'applicant_crm' applicant.id %}" class="btn btn-outline-light">
                    <i class="fas fa-database me-2"></i>CRM
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Application Status Banner -->
    {% if application %}    
    <div class="alert 
        {% if application.get_status_display == 'New' %} alert-primary
        {% elif application.get_status_display == 'Pending Review' %} alert-warning text-dark
        {% elif application.get_status_display == 'Approved' %} alert-success
        {% elif application.get_status_display == 'Rejected' %} alert-danger
        {% elif application.get_status_display == 'Waitlisted' %} alert-info
        {% else %} alert-secondary
        {% endif %} 
        text-center fw-bold shadow-sm mb-4" role="alert">
        
        <i class="fas fa-home me-2"></i>Application Status: <strong>{{ application.get_status_display }}</strong>
        <br>
        <a href="{% url 'application_detail' application.unique_link %}" class="btn btn-light btn-sm mt-2" target="_blank">
            <i class="fas fa-external-link-alt me-1"></i>View Application
        </a>
    </div>
    {% endif %}

    <!-- Profile Overview Section -->
    <div class="profile-section">
        <div class="row align-items-center">
            <!-- Profile Photo Column -->
            <div class="col-lg-3 text-center">
                <div class="profile-photo-container mb-4">
                    {% if applicant.photos.all %}
                        <img src="{{ applicant.photos.first.large_url }}" class="profile-photo" alt="Profile Picture">
                    {% else %}
                        <img src="{% static 'images/default-profile.png' %}" class="profile-photo" alt="Default Profile">
                    {% endif %}
                </div>

                <!-- Status & Broker Info -->
                <div class="status-badge {% if applicant.placement_status == 'placed' %}bg-success text-white{% elif applicant.placement_status == 'withdrawn' %}bg-danger text-white{% else %}bg-secondary text-white{% endif %} mb-3">
                    <i class="fas fa-info-circle"></i>
                    {{ applicant.get_placement_status_display }}
                </div>
                
                {% if applicant.placed_apartment %}
                    <div class="small text-muted mb-2">
                        <i class="fas fa-building"></i> Placed in: {{ applicant.placed_apartment.building.name }}
                    </div>
                {% endif %}

                {% if applicant.assigned_broker %}
                    <div class="small">
                        <i class="fas fa-user-tie text-warning"></i>
                        <strong>Assigned Broker</strong><br>
                        {{ applicant.assigned_broker.get_full_name }}
                    </div>
                {% endif %}
            </div>

            <!-- Basic Information Column -->
            <div class="col-lg-9">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-birthday-cake text-warning"></i> Date of Birth
                        </div>
                        <div class="info-value">{{ applicant.date_of_birth|default:"Not provided" }}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-calendar-alt text-warning"></i> Desired Move-In Date
                        </div>
                        <div class="info-value">
                            {% if applicant.desired_move_in_date %}
                                <span class="badge bg-warning text-dark fs-6 px-3 py-2">{{ applicant.desired_move_in_date }}</span>
                            {% else %}
                                <span class="text-muted">Not specified</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-phone text-warning"></i> Phone
                        </div>
                        <div class="info-value">{{ applicant.phone_number|default:"Not provided" }}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-envelope text-warning"></i> Email
                        </div>
                        <div class="info-value">{{ applicant.email|default:"Not provided" }}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-home text-warning"></i> Current Address
                        </div>
                        <div class="info-value">
                            {% if applicant.street_address_1 %}
                                {{ applicant.street_address_1 }}<br>
                                {% if applicant.street_address_2 %}{{ applicant.street_address_2 }}<br>{% endif %}
                                {{ applicant.city }}, {{ applicant.get_state_display }} {{ applicant.zip_code }}
                                {% if applicant.length_at_current_address %}
                                    <br><small class="text-muted">Length at address: {{ applicant.length_at_current_address }}</small>
                                {% endif %}
                            {% else %}
                                Not provided
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">
                            <i class="fas fa-id-card text-warning"></i> Identification Documents
                        </div>
                        <div class="info-value">
                            {% for doc in applicant.identification_documents.all %}
                                {% if doc.document_image_front or doc.document_image_back %}
                                    <span class="badge bg-success text-white me-2">{{ doc.get_id_type_display }} âœ“</span>
                                {% endif %}
                            {% empty %}
                                <span class="text-muted">Not provided</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Insights Section (Only for Brokers and Admins) -->
    {% if smart_insights %}
    <div class="profile-section" style="border-left: 4px solid #17a2b8; background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-brain"></i>Smart Insights <span class="badge bg-primary ms-2">AI Analysis</span></h3>
            <button class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#privacyModal">
                <i class="fas fa-shield-alt me-2"></i>Privacy Info
            </button>
        </div>
        
        <!-- Privacy Notice -->
        <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
            <div class="d-flex align-items-start">
                <i class="fas fa-lock me-2 mt-1"></i>
                <div>
                    <strong>Privacy Protected:</strong> This analysis is performed locally using rule-based algorithms. 
                    <strong>No personal information is sent to external AI services.</strong> 
                    All data remains secure within your system.
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <!-- Overall Assessment -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="alert alert-{% if smart_insights.overall_score >= 80 %}success{% elif smart_insights.overall_score >= 60 %}warning{% else %}danger{% endif %} mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="alert-heading mb-2">
                                <i class="fas fa-chart-line me-2"></i>Overall Score: {{ smart_insights.overall_score }}/100
                            </h5>
                            <p class="mb-0">{{ smart_insights.summary|safe }}</p>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-{% if smart_insights.confidence_level == 'High' %}success{% elif smart_insights.confidence_level == 'Medium' %}warning{% else %}danger{% endif %} fs-6">
                                {{ smart_insights.confidence_level }} Confidence
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="text-center">
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar bg-{% if smart_insights.overall_score >= 80 %}success{% elif smart_insights.overall_score >= 60 %}warning{% else %}danger{% endif %}" 
                             style="width: {{ smart_insights.overall_score }}%">
                            {{ smart_insights.overall_score }}%
                        </div>
                    </div>
                    <small class="text-muted">Risk Assessment Score</small>
                </div>
            </div>
        </div>
        
        <!-- Detailed Analysis -->
        <div class="row">
            <!-- Affordability Analysis -->
            <div class="col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-{% if smart_insights.affordability.can_afford %}success{% elif smart_insights.affordability.income_multiple >= 2.5 %}warning{% else %}danger{% endif %} text-white">
                        <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>Affordability</h6>
                    </div>
                    <div class="card-body">
                        {% if smart_insights.affordability.recommended_rent > 0 %}
                            <p class="card-text">
                                <strong>Recommended Rent:</strong><br>
                                <span class="text-success fs-5">${{ smart_insights.affordability.recommended_rent|floatformat:0 }}/month</span>
                            </p>
                        {% endif %}
                        {% if smart_insights.affordability.income_multiple > 0 %}
                            <p class="card-text">
                                <strong>Income Multiple:</strong><br>
                                <span class="{% if smart_insights.affordability.income_multiple >= 3 %}text-success{% elif smart_insights.affordability.income_multiple >= 2.5 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ smart_insights.affordability.income_multiple|floatformat:1 }}x
                                </span>
                            </p>
                        {% endif %}
                        <small class="text-muted">{{ smart_insights.affordability.details }}</small>
                    </div>
                </div>
            </div>
            
            <!-- Employment Analysis -->
            <div class="col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-briefcase me-2"></i>Employment Stability</h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <strong>Employment Length:</strong><br>
                            {{ smart_insights.employment_stability.employment_length }}
                        </p>
                        <p class="card-text">
                            <strong>Job Count:</strong> {{ smart_insights.employment_stability.job_count }}
                        </p>
                        {% if smart_insights.employment_stability.strengths %}
                            <div class="mb-2">
                                <small class="text-success">
                                    <i class="fas fa-check-circle me-1"></i>
                                    {{ smart_insights.employment_stability.strengths.0 }}
                                </small>
                            </div>
                        {% endif %}
                        {% if smart_insights.employment_stability.concerns %}
                            <div>
                                <small class="text-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    {{ smart_insights.employment_stability.concerns.0 }}
                                </small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Rental History Analysis -->
            <div class="col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="fas fa-home me-2"></i>Rental History</h6>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            <strong>Previous Addresses:</strong> {{ smart_insights.rental_history.address_count }}
                        </p>
                        {% if smart_insights.rental_history.strengths %}
                            {% for strength in smart_insights.rental_history.strengths %}
                                <div class="mb-1">
                                    <small class="text-success">
                                        <i class="fas fa-check-circle me-1"></i>{{ strength }}
                                    </small>
                                </div>
                            {% endfor %}
                        {% endif %}
                        {% if smart_insights.rental_history.concerns %}
                            {% for concern in smart_insights.rental_history.concerns %}
                                <div class="mb-1">
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ concern }}
                                    </small>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Red Flags and Recommendations -->
        <div class="row">
            <!-- Red Flags -->
            {% if smart_insights.red_flags %}
            <div class="col-lg-6 mb-3">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0"><i class="fas fa-flag me-2"></i>Red Flags ({{ smart_insights.red_flags|length }})</h6>
                    </div>
                    <div class="card-body">
                        {% for flag in smart_insights.red_flags %}
                            <div class="mb-2">
                                <small class="text-danger">{{ flag }}</small>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Recommendations -->
            <div class="col-lg-{% if smart_insights.red_flags %}6{% else %}12{% endif %} mb-3">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Next Steps ({{ smart_insights.recommendations|length }})</h6>
                    </div>
                    <div class="card-body">
                        {% for rec in smart_insights.recommendations %}
                            <div class="mb-2">
                                <small class="text-success">{{ rec }}</small>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Employment & Income Section -->
    <div class="profile-section">
        <h3><i class="fas fa-briefcase"></i>Employment & Income</h3>
        
        <!-- Employment Status -->
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Employment Status</div>
                <div class="info-value">{{ applicant.get_employment_status_display|default:"Not specified" }}</div>
            </div>
        </div>
        
        <!-- Primary Employment Information -->
        {% if applicant.employment_status == 'employed' or applicant.company_name %}
            <h4 class="h5 mb-3 text-secondary">Primary Employment</h4>
            <div class="employment-card">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Company</div>
                        <div class="info-value">{{ applicant.company_name|default:"Not provided" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Position</div>
                        <div class="info-value">{{ applicant.position|default:"Not provided" }}</div>
                    </div>
                    {% if applicant.annual_income %}
                    <div class="info-item">
                        <div class="info-label">Annual Income</div>
                        <div class="info-value text-success fw-bold">${{ applicant.annual_income|floatformat:2 }}</div>
                    </div>
                    {% endif %}
                    {% if applicant.supervisor_name %}
                    <div class="info-item">
                        <div class="info-label">Supervisor</div>
                        <div class="info-value">{{ applicant.supervisor_name }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Supervisor Contact</div>
                        <div class="info-value">
                            {% if applicant.supervisor_phone %}{{ applicant.supervisor_phone }}{% endif %}
                            {% if applicant.supervisor_phone and applicant.supervisor_email %}<br>{% endif %}
                            {% if applicant.supervisor_email %}{{ applicant.supervisor_email }}{% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if applicant.employment_start_date %}
                    <div class="info-item">
                        <div class="info-label">Employment Period</div>
                        <div class="info-value">
                            {{ applicant.employment_start_date }} 
                            {% if applicant.employment_end_date %}
                                to {{ applicant.employment_end_date }}
                            {% elif applicant.currently_employed %}
                                to Present
                            {% endif %}
                            {% if applicant.currently_employed and applicant.employment_start_date %}
                                <br><small class="text-success">
                                    <i class="fas fa-clock"></i> 
                                    Started {{ applicant.employment_start_date.year }}
                                    {% now "Y" as current_year %}
                                    {% if current_year > applicant.employment_start_date.year %}
                                        ({{ applicant.employment_start_date.year|date:"Y" }}-{{ current_year }})
                                    {% endif %}
                                </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% if applicant.currently_employed is not None %}
                    <div class="info-item">
                        <div class="info-label">Currently Employed</div>
                        <div class="info-value">
                            <span class="badge {% if applicant.currently_employed %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ applicant.currently_employed|yesno:"Yes,No" }}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        
        <!-- Student Information -->
        {% if applicant.employment_status == 'student' %}
            <h4 class="h5 mb-3 text-secondary">Student Information</h4>
            <div class="employment-card">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">School</div>
                        <div class="info-value">{{ applicant.school_name|default:"Not provided" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Expected Graduation</div>
                        <div class="info-value">{{ applicant.year_of_graduation|default:"Not provided" }}</div>
                    </div>
                    {% if applicant.school_address %}
                    <div class="info-item">
                        <div class="info-label">School Address</div>
                        <div class="info-value">{{ applicant.school_address }}</div>
                    </div>
                    {% endif %}
                    {% if applicant.school_phone %}
                    <div class="info-item">
                        <div class="info-label">School Phone</div>
                        <div class="info-value">{{ applicant.school_phone }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        
        <!-- Multiple Jobs -->
        {% if applicant.jobs.all %}
            <h4 class="h5 mb-3 text-secondary">Additional Jobs</h4>
            <div class="row">
                {% for job in applicant.jobs.all %}
                    <div class="col-lg-6 mb-3">
                        <div class="employment-card">
                            <h4>{{ job.company_name }} - {{ job.position }}</h4>
                            <div class="info-grid">
                                {% if job.annual_income %}
                                <div class="info-item">
                                    <div class="info-label">Annual Income</div>
                                    <div class="info-value text-success fw-bold">${{ job.annual_income|floatformat:2 }}</div>
                                </div>
                                {% endif %}
                                {% if job.supervisor_name %}
                                <div class="info-item">
                                    <div class="info-label">Supervisor</div>
                                    <div class="info-value">{{ job.supervisor_name }}</div>
                                </div>
                                {% endif %}
                                {% if job.supervisor_phone or job.supervisor_email %}
                                <div class="info-item">
                                    <div class="info-label">Contact</div>
                                    <div class="info-value">
                                        {% if job.supervisor_phone %}{{ job.supervisor_phone }}{% endif %}
                                        {% if job.supervisor_phone and job.supervisor_email %}<br>{% endif %}
                                        {% if job.supervisor_email %}{{ job.supervisor_email }}{% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                {% if job.employment_start_date %}
                                <div class="info-item">
                                    <div class="info-label">Period</div>
                                    <div class="info-value">
                                        {{ job.employment_start_date }} 
                                        {% if job.employment_end_date %}
                                            to {{ job.employment_end_date }}
                                        {% elif job.currently_employed %}
                                            to Present
                                        {% endif %}
                                        {% if job.currently_employed and job.employment_start_date %}
                                            <br><small class="text-success">
                                                <i class="fas fa-clock"></i> 
                                                Started {{ job.employment_start_date.year }}
                                                {% now "Y" as current_year %}
                                                {% if current_year > job.employment_start_date.year %}
                                                    ({{ job.employment_start_date.year|date:"Y" }}-{{ current_year }})
                                                {% endif %}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                <div class="info-item">
                                    <div class="info-label">Job Type</div>
                                    <div class="info-value">{{ job.get_job_type_display }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Income Sources -->
        {% if applicant.income_sources.all %}
            <h4 class="h5 mb-3 text-secondary">Additional Income Sources</h4>
            <div class="row">
                {% for income in applicant.income_sources.all %}
                    <div class="col-lg-6 mb-3">
                        <div class="asset-card">
                            <h4>{{ income.income_source }}</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Average Annual Income</div>
                                    <div class="info-value text-success fw-bold">${{ income.average_annual_income|floatformat:2 }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Type</div>
                                    <div class="info-value">{{ income.get_source_type_display }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Assets -->
        {% if applicant.assets.all %}
            <h4 class="h5 mb-3 text-secondary">Financial Assets</h4>
            <div class="row">
                {% for asset in applicant.assets.all %}
                    <div class="col-lg-6 mb-3">
                        <div class="asset-card">
                            <h4>{{ asset.asset_name }}</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Account Balance</div>
                                    <div class="info-value text-info fw-bold">${{ asset.account_balance|floatformat:2 }}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Type</div>
                                    <div class="info-value">{{ asset.get_asset_type_display }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Rental History Section -->
    <div class="profile-section">
        <h3><i class="fas fa-home"></i>Rental History</h3>
        
        <div class="info-grid mb-4">
            <div class="info-item">
                <div class="info-label">Current Housing Status</div>
                <div class="info-value">{{ applicant.get_housing_status_display|default:"Not specified" }}</div>
            </div>
            {% if applicant.monthly_rent %}
            <div class="info-item">
                <div class="info-label">Monthly Rent</div>
                <div class="info-value text-success fw-bold">${{ applicant.monthly_rent|floatformat:2 }}</div>
            </div>
            {% endif %}
            {% if applicant.current_landlord_name %}
            <div class="info-item">
                <div class="info-label">Current Landlord</div>
                <div class="info-value">{{ applicant.current_landlord_name }}</div>
            </div>
            {% endif %}
            {% if applicant.current_landlord_phone or applicant.current_landlord_email %}
            <div class="info-item">
                <div class="info-label">Landlord Contact</div>
                <div class="info-value">
                    {% if applicant.current_landlord_phone %}{{ applicant.current_landlord_phone }}{% endif %}
                    {% if applicant.current_landlord_phone and applicant.current_landlord_email %}<br>{% endif %}
                    {% if applicant.current_landlord_email %}{{ applicant.current_landlord_email }}{% endif %}
                </div>
            </div>
            {% endif %}
            {% if applicant.reason_for_moving %}
            <div class="info-item">
                <div class="info-label">Reason for Moving</div>
                <div class="info-value">{{ applicant.reason_for_moving }}</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Previous Addresses -->
        {% if applicant.previous_addresses.all %}
            <h4 class="h5 mb-3 text-secondary">Previous Addresses</h4>
            <div class="row">
                {% for address in applicant.previous_addresses.all %}
                    <div class="col-lg-6 mb-3">
                        <div class="address-card">
                            <h5 class="h6 mb-2 text-warning">Address #{{ address.order }}</h5>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Address</div>
                                    <div class="info-value">
                                        {{ address.street_address_1 }}<br>
                                        {% if address.street_address_2 %}{{ address.street_address_2 }}<br>{% endif %}
                                        {{ address.city }}, {{ address.get_state_display }} {{ address.zip_code }}
                                    </div>
                                </div>
                                {% if address.length_at_address %}
                                <div class="info-item">
                                    <div class="info-label">Duration</div>
                                    <div class="info-value">{{ address.length_at_address }}</div>
                                </div>
                                {% endif %}
                                {% if address.landlord_name %}
                                <div class="info-item">
                                    <div class="info-label">Landlord</div>
                                    <div class="info-value">{{ address.landlord_name }}</div>
                                </div>
                                {% endif %}
                                {% if address.landlord_phone %}
                                <div class="info-item">
                                    <div class="info-label">Landlord Contact</div>
                                    <div class="info-value">{{ address.landlord_phone }}</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Preferences Section -->
    <div class="profile-section">
        <h3><i class="fas fa-star"></i>Housing Preferences</h3>
        
        <!-- Housing Requirements -->
        <h4 class="h5 mb-3 text-secondary">Housing Requirements</h4>
        <div class="info-grid mb-4">
            {% if applicant.min_bedrooms or applicant.max_bedrooms %}
            <div class="info-item">
                <div class="info-label">Bedrooms</div>
                <div class="info-value">
                    {% if applicant.min_bedrooms and applicant.max_bedrooms %}
                        {{ applicant.min_bedrooms }} - {{ applicant.max_bedrooms }}
                    {% elif applicant.min_bedrooms %}
                        {{ applicant.min_bedrooms }}+
                    {% elif applicant.max_bedrooms %}
                        Up to {{ applicant.max_bedrooms }}
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% if applicant.min_bathrooms or applicant.max_bathrooms %}
            <div class="info-item">
                <div class="info-label">Bathrooms</div>
                <div class="info-value">
                    {% if applicant.min_bathrooms and applicant.max_bathrooms %}
                        {{ applicant.min_bathrooms }} - {{ applicant.max_bathrooms }}
                    {% elif applicant.min_bathrooms %}
                        {{ applicant.min_bathrooms }}+
                    {% elif applicant.max_bathrooms %}
                        Up to {{ applicant.max_bathrooms }}
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% if applicant.max_rent_budget %}
            <div class="info-item">
                <div class="info-label">Max Budget</div>
                <div class="info-value text-success fw-bold">${{ applicant.max_rent_budget|floatformat:2 }}</div>
            </div>
            {% endif %}
            <div class="info-item">
                <div class="info-label">Open to Roommates</div>
                <div class="info-value">
                    <span class="badge {% if applicant.open_to_roommates %}bg-success{% else %}bg-secondary{% endif %}">
                        {{ applicant.open_to_roommates|yesno:"Yes,No" }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Neighborhood Preferences -->
        {% if applicant.neighborhood_preferences.all %}
            <h4 class="h5 mb-3 text-secondary">Neighborhood Preferences</h4>
            <div class="mb-4">
                {% for neighborhood in applicant.neighborhood_preferences.all %}
                    <span class="badge bg-warning text-dark me-2 mb-2">{{ neighborhood.name }}</span>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Ranked Neighborhood Preferences -->
        {% if applicant.ranked_neighborhood_preferences.all %}
            <h4 class="h5 mb-3 text-secondary">Ranked Neighborhood Preferences</h4>
            <div class="mb-4">
                <ol class="list-unstyled">
                    {% for preference in applicant.neighborhoodpreference_set.all %}
                        <li class="mb-2">
                            <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
                            {{ preference.neighborhood.name }}
                        </li>
                    {% endfor %}
                </ol>
            </div>
        {% endif %}

        <!-- Amenities Preferences -->
        {% if applicant.amenities.all %}
            <h4 class="h5 mb-3 text-secondary">Amenities Preferences</h4>
            <div class="mb-4">
                {% for amenity in applicant.amenities.all %}
                    <span class="badge bg-info text-white me-2 mb-2">{{ amenity.name }}</span>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Building Amenity Preferences -->
        {% if applicant.building_amenity_preferences.all %}
            <h4 class="h5 mb-3 text-secondary">Building Amenity Preferences</h4>
            <div class="mb-4">
                {% for pref in applicant.building_amenity_preferences.all %}
                    <span class="badge bg-light text-dark me-2 mb-2 border">
                        {{ pref.amenity.name }} ({{ pref.get_priority_level_display }})
                    </span>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Apartment Amenity Preferences -->
        {% if applicant.apartment_amenity_preferences.all %}
            <h4 class="h5 mb-3 text-secondary">Apartment Amenity Preferences</h4>
            <div class="mb-4">
                {% for pref in applicant.apartment_amenity_preferences.all %}
                    <span class="badge bg-light text-dark me-2 mb-2 border">
                        {{ pref.amenity.name }} ({{ pref.get_priority_level_display }})
                    </span>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <!-- Pets Section -->
    {% if applicant.pets.all %}
    <div class="profile-section">
        <h3><i class="fas fa-paw"></i>Pets</h3>
        
        <div class="row">
            {% for pet in applicant.pets.all %}
                <div class="col-lg-6 mb-4">
                    <div class="pet-card">
                        <h4 class="h5 mb-3">
                            <i class="fas fa-paw text-warning me-2"></i>
                            {{ pet.pet_type }}
                            {% if pet.name %}- {{ pet.name }}{% endif %}
                        </h4>
                        
                        <div class="info-grid mb-3">
                            <div class="info-item">
                                <div class="info-label">Quantity</div>
                                <div class="info-value">{{ pet.quantity }}</div>
                            </div>
                            {% if pet.description %}
                            <div class="info-item">
                                <div class="info-label">Description</div>
                                <div class="info-value">{{ pet.description }}</div>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if pet.photos.all %}
                            <div class="row">
                                {% for photo in pet.photos.all %}
                                    <div class="col-4 mb-2">
                                        <img src="{{ photo.thumbnail_url }}" class="img-fluid rounded shadow-sm" alt="Pet Photo">
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}


    <!-- Identification Documents Section -->
    {% if applicant.identification_documents.all %}
    <div class="profile-section">
        <h3><i class="fas fa-id-card"></i>Identification Documents</h3>
        
        <div class="row">
            {% for doc in applicant.identification_documents.all %}
                {% if doc.document_image_front or doc.document_image_back %}
                    <div class="col-12 mb-4">
                        <div class="asset-card">
                            <h4 class="h5 mb-3 text-primary">{{ doc.get_id_type_display }}</h4>
                            
                            <div class="row">
                                {% if doc.document_image_front %}
                                    <div class="col-md-6 mb-3">
                                        <div class="text-center">
                                            <h5 class="h6 text-secondary mb-3">Front</h5>
                                            <img src="{{ doc.document_image_front.url }}" 
                                                 class="img-fluid rounded shadow-sm" 
                                                 alt="{{ doc.get_id_type_display }} - Front" 
                                                 style="max-height: 250px; cursor: pointer;" 
                                                 onclick="window.open('{{ doc.document_image_front.url }}', '_blank')">
                                            <p class="small text-muted mt-2">Click to view full size</p>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                {% if doc.document_image_back %}
                                    <div class="col-md-6 mb-3">
                                        <div class="text-center">
                                            <h5 class="h6 text-secondary mb-3">Back</h5>
                                            <img src="{{ doc.document_image_back.url }}" 
                                                 class="img-fluid rounded shadow-sm" 
                                                 alt="{{ doc.get_id_type_display }} - Back" 
                                                 style="max-height: 250px; cursor: pointer;" 
                                                 onclick="window.open('{{ doc.document_image_back.url }}', '_blank')">
                                            <p class="small text-muted mt-2">Click to view full size</p>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                            
                            {% if doc.document_number %}
                                <div class="mt-3">
                                    <small class="text-muted">Document Number: {{ doc.document_number }}</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        
        <!-- Show count of documents -->
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> 
                {{ applicant.identification_documents.count }} identification document(s) on file
            </small>
        </div>
    </div>
    {% endif %}

    <!-- Matching Apartments Section -->
    {% if matching_apartments %}
    <div class="profile-section">
        <h3>
            <i class="fas fa-home"></i>
            Matching Apartments
            <span class="badge bg-primary ms-2">{{ matching_apartments|length }} Found</span>
        </h3>
        
        <div class="row">
            {% for match in matching_apartments %}
            <div class="col-lg-6 mb-4">
                <div class="card h-100 border-0" style="box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <!-- Match Score Header -->
                    <div class="card-header bg-transparent border-bottom-0 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="match-score me-3">
                                <div class="circular-progress" style="
                                    background: conic-gradient(
                                        #ffcc00 0deg {{ match.match_percentage|floatformat:0 }}%,
                                        #e9ecef {{ match.match_percentage|floatformat:0 }}% 100%
                                    );
                                    width: 60px; height: 60px; border-radius: 50%; 
                                    display: flex; align-items: center; justify-content: center;
                                    position: relative;
                                ">
                                    <div style="
                                        background: white; width: 46px; height: 46px; 
                                        border-radius: 50%; display: flex; align-items: center; 
                                        justify-content: center; font-weight: 700; color: #2c3e50;
                                    ">
                                        {{ match.match_percentage|floatformat:0 }}%
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-1 fw-bold">{{ match.apartment.building.name }}</h6>
                                <small class="text-muted">Unit {{ match.apartment.unit_number }}</small>
                            </div>
                        </div>
                        <span class="badge 
                            {% if match.match_percentage >= 80 %}bg-success
                            {% elif match.match_percentage >= 60 %}bg-warning
                            {% else %}bg-secondary{% endif %}">
                            {% if match.match_percentage >= 80 %}Excellent Match
                            {% elif match.match_percentage >= 60 %}Good Match
                            {% else %}Fair Match{% endif %}
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <!-- Apartment Details -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Bedrooms</small>
                                <div class="fw-semibold">{{ match.apartment.bedrooms|default:"Studio" }}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Rent</small>
                                <div class="fw-semibold text-success">${{ match.apartment.rent_price|floatformat:0 }}/mo</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">Bathrooms</small>
                                <div class="fw-semibold">{{ match.apartment.bathrooms }}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Available</small>
                                <div class="fw-semibold">
                                    {% if match.apartment.status == 'available' %}
                                        <span class="text-success">Now</span>
                                    {% else %}
                                        <span class="text-warning">{{ match.apartment.get_status_display }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Match Breakdown -->
                        <div class="match-details">
                            <small class="text-muted d-block mb-2">Match Breakdown:</small>
                            <div class="progress-stack">
                                {% if match.match_details.basic_score > 0 %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small>Basic Requirements</small>
                                    <small class="text-success">{{ match.match_details.basic_score|floatformat:0 }}pts</small>
                                </div>
                                {% endif %}
                                
                                {% if match.match_details.building_amenities_score > 0 %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small>Building Amenities</small>
                                    <small class="text-primary">{{ match.match_details.building_amenities_score|floatformat:0 }}pts</small>
                                </div>
                                {% endif %}
                                
                                {% if match.match_details.apartment_amenities_score > 0 %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small>Apartment Features</small>
                                    <small class="text-info">{{ match.match_details.apartment_amenities_score|floatformat:0 }}pts</small>
                                </div>
                                {% endif %}
                                
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small>Within Budget</small>
                                    {% if match.match_details.rent_within_budget %}
                                        <small class="text-success"><i class="fas fa-check"></i> Yes</small>
                                    {% else %}
                                        <small class="text-danger"><i class="fas fa-times"></i> No</small>
                                    {% endif %}
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small>Preferred Neighborhood</small>
                                    {% if match.match_details.preferred_neighborhood %}
                                        <small class="text-success"><i class="fas fa-check"></i> Yes</small>
                                    {% else %}
                                        <small class="text-muted"><i class="fas fa-times"></i> No</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mt-3">
                            <a href="{% url 'apartment_detail' match.apartment.id %}" 
                               class="btn btn-outline-primary btn-sm flex-fill">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                            <button class="btn btn-primary btn-sm flex-fill" 
                                    onclick="recommendApartment({{ match.apartment.id }}, {{ applicant.id }})">
                                <i class="fas fa-paper-plane"></i> Recommend
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if matching_apartments|length >= 10 %}
        <div class="text-center">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> 
                Showing top 10 matches. Refine search criteria for more specific results.
            </small>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="profile-section">
        <h3>
            <i class="fas fa-home"></i>
            Matching Apartments
        </h3>
        <div class="text-center py-4">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No Matching Apartments Found</h5>
            <p class="text-muted">
                {% if not applicant.max_rent_budget %}
                    Complete the applicant's housing preferences to find matching apartments.
                {% else %}
                    No apartments currently match this applicant's criteria. 
                    Consider adjusting search parameters or adding new inventory.
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Privacy Information Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="privacyModalLabel">
                    <i class="fas fa-shield-alt me-2"></i>Smart Insights Privacy & Security
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <h6 class="text-success"><i class="fas fa-check-circle me-2"></i>How We Protect Your Data</h6>
                        <ul class="list-unstyled mb-4">
                            <li class="mb-2">
                                <i class="fas fa-server text-primary me-2"></i>
                                <strong>Local Processing:</strong> All analysis is performed on your own servers using rule-based algorithms
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-ban text-danger me-2"></i>
                                <strong>No External APIs:</strong> No personal information is sent to OpenAI, Anthropic, or any external AI services
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-lock text-success me-2"></i>
                                <strong>Data Security:</strong> All applicant data remains within your secure database environment
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-user-shield text-info me-2"></i>
                                <strong>PII Protected:</strong> Names, addresses, SSNs, and sensitive data never leave your system
                            </li>
                        </ul>
                        
                        <h6 class="text-info"><i class="fas fa-cog me-2"></i>How Smart Insights Works</h6>
                        <div class="bg-light p-3 rounded mb-4">
                            <p class="mb-2"><strong>1. Data Analysis:</strong> The system analyzes numerical values (income, employment dates, rent budget) and categorical data (employment status, housing type)</p>
                            <p class="mb-2"><strong>2. Rule-Based Scoring:</strong> Uses established rental industry standards (like the 3x income rule) to calculate scores</p>
                            <p class="mb-2"><strong>3. Pattern Recognition:</strong> Identifies common red flags and positive indicators based on rental management best practices</p>
                            <p class="mb-0"><strong>4. Instant Results:</strong> Generates insights in real-time without external network requests</p>
                        </div>
                        
                        <h6 class="text-warning"><i class="fas fa-info-circle me-2"></i>What Gets Analyzed</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled small">
                                    <li>ðŸ“Š Income amounts and ratios</li>
                                    <li>ðŸ“… Employment duration calculations</li>
                                    <li>ðŸ  Housing history patterns</li>
                                    <li>ðŸ’¼ Job count and stability</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled small">
                                    <li>ðŸš© Missing information flags</li>
                                    <li>âš–ï¸ Income-to-rent ratios</li>
                                    <li>ðŸ“‹ Data completeness scores</li>
                                    <li>âœ… Verification recommendations</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="alert alert-success mt-3">
                            <h6 class="alert-heading">ðŸ”’ Privacy Guarantee</h6>
                            <p class="mb-0">
                                This analysis system is designed with privacy-first principles. No applicant names, addresses, 
                                phone numbers, or personally identifiable information is processed by external AI systems. 
                                All insights are generated using secure, local computational methods.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-thumbs-up me-2"></i>Understood
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function recommendApartment(apartmentId, applicantId) {
    // TODO: Implement apartment recommendation functionality
    alert(`Recommend apartment ${apartmentId} to applicant ${applicantId}? This feature is coming soon!`);
}
</script>

{% endblock %}