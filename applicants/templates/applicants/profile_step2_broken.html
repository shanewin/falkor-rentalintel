{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/doorway-forms.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>My Applicant Profile</h1>
                <p>Fill out as much information as possible to receive more matches and make applying easier</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'applicant_dashboard' %}" class="btn btn-outline-primary">
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Progress Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <h6 class="mb-3">Profile Completion Progress ({{ completion_percentage }}% Complete)</h6>
            <div class="progress mb-3" style="height: 6px;">
                <div class="progress-bar" style="width: 66%; background-color: #ffcc00;"></div>
            </div>
            <div class="row text-center">
                <div class="col-4">
                    <a href="{% url 'profile_step1' %}" class="text-decoration-none">
                        <div class="step text-muted">
                            <div class="step-number bg-light text-muted">1</div>
                            <small>Personal Info</small>
                        </div>
                    </a>
                </div>
                <div class="col-4">
                    <a href="{% url 'profile_step2' %}" class="text-decoration-none">
                        <div class="step" style="color: #ffcc00;">
                            <div class="step-number text-white" style="background-color: #000000;">2</div>
                            <small>Housing Needs & Preferences</small>
                        </div>
                    </a>
                </div>
                <div class="col-4">
                    <a href="{% url 'profile_step3' %}" class="text-decoration-none">
                        <div class="step text-muted">
                            <div class="step-number bg-light text-muted">3</div>
                            <small>Employment</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Housing Needs and Preferences -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Step 2: Housing Needs and Preferences</h5>
        </div>
        <div class="card-body">
            <form method="post" class="doorway-form">
                {% csrf_token %}
                {% crispy form form.helper %}
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include SortableJS first -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<!-- Include forms.js -->
<script src="{% static 'js/forms.js' %}"></script>

<!-- Our page-specific JavaScript -->
<script>
// Use a self-executing function to avoid global scope pollution
(function() {
    // Wait for DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeStep2);
    } else {
        // DOM is already ready
        initializeStep2();
    }
    
    function initializeStep2() {
        // Prevent double initialization
        if (window.profileStep2Initialized) {
            console.log('Profile Step 2 already initialized, skipping...');
            return;
        }
        window.profileStep2Initialized = true;
    
    console.log('Profile Step 2: DOM Ready!');
    
    // Initialize neighborhood ranking system
    setupNeighborhoodRanking();
    
    // Initialize amenities selection system
    setupAmenitiesSelection();
    
    // Test pets checkbox
    const petsCheckbox = document.getElementById('has_pets');
    const petsContainer = document.getElementById('pets-container');
    
    console.log('Pets checkbox:', petsCheckbox);
    console.log('Pets container:', petsContainer);
    
    if (petsCheckbox) {
        petsCheckbox.addEventListener('change', function() {
            console.log('Pets checkbox changed:', this.checked);
            if (petsContainer) {
                petsContainer.style.display = this.checked ? 'block' : 'none';
                console.log('Pets container display set to:', this.checked ? 'block' : 'none');
                
                // Add Pet 1 form when pets is checked
                if (this.checked) {
                    addFirstPetForm();
                } else {
                    // Clear pets when unchecked
                    const petsListContainer = document.getElementById('pets-list-container');
                    if (petsListContainer) {
                        petsListContainer.innerHTML = '';
                        petCount = 0; // Reset pet count
                        
                        // Show add button again
                        const addPetBtn = document.getElementById('add-pet-btn');
                        if (addPetBtn) {
                            addPetBtn.style.display = 'inline-block';
                        }
                    }
                }
            }
        });
    }
    
    // Handle +Add Pet button (prevent double-clicking)
    const addPetBtn = document.getElementById('add-pet-btn');
    if (addPetBtn) {
        console.log('Found Add Pet button');
        addPetBtn.addEventListener('click', function() {
            // Prevent rapid clicking
            if (this.disabled) return;
            this.disabled = true;
            
            console.log('Add Pet button clicked');
            addNextPetForm();
            
            // Re-enable after short delay
            var self = this;
            setTimeout(function() {
                self.disabled = false;
            }, 500);
        });
    }
    
    // Track number of pets
    let petCount = 0;
    const maxPets = 5;
    
    // Function to add the first pet form
    function addFirstPetForm() {
        const petsListContainer = document.getElementById('pets-list-container');
        if (petsListContainer && petCount === 0) {
            console.log('Adding Pet 1 form...');
            petCount = 1;
            const petHTML = createSimplePetForm(1);
            petsListContainer.innerHTML = petHTML;
        }
    }
    
    // Function to add additional pet forms
    function addNextPetForm() {
        const petsListContainer = document.getElementById('pets-list-container');
        if (petsListContainer && petCount < maxPets) {
            const nextPetNumber = petCount + 1;
            
            // Check if pet already exists
            if (document.getElementById('pet_' + nextPetNumber)) {
                console.log('Pet ' + nextPetNumber + ' already exists, skipping...');
                return;
            }
            
            petCount++;
            console.log('Adding Pet ' + petCount + ' form...');
            const petHTML = createSimplePetForm(petCount);
            petsListContainer.innerHTML += petHTML;
            
            // Hide add button if at max
            if (petCount >= maxPets) {
                const addPetBtn = document.getElementById('add-pet-btn');
                if (addPetBtn) {
                    addPetBtn.style.display = 'none';
                }
            }
        }
    }
    
    // Simple pet form creator
    function createSimplePetForm(index) {
        return '<div class="pet-container card mb-3" id="pet_' + index + '">' +
            '<div class="card-header">' +
                '<h6 class="mb-0"><i class="fas fa-paw"></i> Pet ' + index + '</h6>' +
            '</div>' +
            '<div class="card-body">' +
                '<div class="row">' +
                    '<div class="col-md-6 mb-3">' +
                        '<label class="form-label">Pet Name</label>' +
                        '<input type="text" name="pet_name_' + index + '" class="form-control" placeholder="Your pet\'s name">' +
                    '</div>' +
                    '<div class="col-md-6 mb-3">' +
                        '<label class="form-label">Pet Type</label>' +
                        '<select name="pet_type_' + index + '" class="form-select">' +
                            '<option value="">Select pet type</option>' +
                            '<option value="Dog">Dog</option>' +
                            '<option value="Cat">Cat</option>' +
                            '<option value="Bird">Bird</option>' +
                            '<option value="Other">Other</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="mb-3">' +
                    '<label class="form-label">Pet Photos</label>' +
                    '<input type="file" name="pet_photo_' + index + '" accept="image/*" class="form-control">' +
                    '<small class="text-muted">Upload a photo of your pet</small>' +
                '</div>' +
                '<div class="mb-3">' +
                    '<label class="form-label">Tell us about your pet</label>' +
                    '<textarea name="pet_description_' + index + '" class="form-control" rows="3" ' +
                        'placeholder="Weight, temperament, special needs, etc."></textarea>' +
                '</div>' +
            '</div>' +
        '</div>';
    }

function setupCurrencyFields() {
    const currencyFields = document.querySelectorAll('.currency-field');
    currencyFields.forEach(function(field) {
        field.addEventListener('blur', function() {
            if (this.value) {
                const value = parseFloat(this.value);
                if (!isNaN(value)) {
                    this.value = value.toFixed(2);
                }
            }
        });
    });
}

function setupPetsSection() {
    const petsCheckbox = document.getElementById('has_pets');
    const petsContainer = document.getElementById('pets-container');
    let petCount = 0;
    const maxPets = 5;
    
    if (petsCheckbox && petsContainer) {
        // Remove any existing event listeners by cloning the checkbox
        const newCheckbox = petsCheckbox.cloneNode(true);
        petsCheckbox.parentNode.replaceChild(newCheckbox, petsCheckbox);
        
        newCheckbox.addEventListener('change', function() {
            if (this.checked) {
                petsContainer.style.display = 'block';
                // Add first pet automatically only if none exist
                if (petCount === 0) {
                    addPetForm();
                }
            } else {
                petsContainer.style.display = 'none';
                // Clear all pets
                const petsListContainer = document.getElementById('pets-list-container');
                petsListContainer.innerHTML = '';
                petCount = 0;
                document.getElementById('add-pet-btn').style.display = 'inline-block';
            }
        });
        
        // Add Pet button functionality
        const addPetBtn = document.getElementById('add-pet-btn');
        if (addPetBtn) {
            // Remove any existing event listeners by cloning
            const newBtn = addPetBtn.cloneNode(true);
            addPetBtn.parentNode.replaceChild(newBtn, addPetBtn);
            
            newBtn.addEventListener('click', function() {
                if (petCount < maxPets) {
                    addPetForm();
                }
            });
        }
    }
    
    function addPetForm() {
        petCount++;
        const petsListContainer = document.getElementById('pets-list-container');
        const petHtml = createPetForm(petCount);
        petsListContainer.insertAdjacentHTML('beforeend', petHtml);
        
        // Hide add button if we've reached max pets
        if (petCount >= maxPets) {
            document.getElementById('add-pet-btn').style.display = 'none';
        }
    }
    
    function createPetForm(index) {
        return '<div class="pet-container card mb-3" data-index="' + index + '" id="pet_' + index + '">' +
            '<div class="card-header d-flex justify-content-between align-items-center">' +
                '<h6 class="mb-0"><i class="fas fa-paw"></i> Pet ' + index + '</h6>' +
                '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removePet(' + index + ')">' +
                    '<i class="fas fa-trash"></i> Remove' +
                '</button>' +
            '</div>' +
            '<div class="card-body">' +
                '<div class="row">' +
                    '<div class="col-md-6 mb-3">' +
                        '<label class="form-label">Pet Name</label>' +
                        '<input type="text" name="pet_name_' + index + '" class="form-control" placeholder="Your pet\'s name">' +
                    '</div>' +
                    '<div class="col-md-6 mb-3">' +
                        '<label class="form-label">Pet Type</label>' +
                        '<select name="pet_type_' + index + '" class="form-select select2">' +
                            '<option value="">Select pet type</option>' +
                            '<option value="Dog">Dog</option>' +
                            '<option value="Cat">Cat</option>' +
                            '<option value="Bird">Bird</option>' +
                            '<option value="Rabbit">Rabbit</option>' +
                            '<option value="Reptile">Reptile</option>' +
                            '<option value="Other">Other</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="mb-3">' +
                    '<label class="form-label">Pet Photos</label>' +
                    '<input type="file" name="pet_photos_' + index + '" accept="image/*" multiple class="form-control">' +
                    '<small class="text-muted">Upload photos of your pet (you can select multiple)</small>' +
                '</div>' +
                '<div class="mb-3">' +
                    '<label class="form-label">Tell us about your pet</label>' +
                    '<textarea name="pet_description_' + index + '" class="form-control" rows="4" ' +
                        'placeholder="Weight of pet, temperament, special needs, training status, etc."></textarea>' +
                '</div>' +
            '</div>' +
        '</div>';
    }
    
    // Global function to remove pets
    window.removePet = function(index) {
        document.getElementById('pet_' + index).remove();
        petCount--;
        
        // Show add button if we're under the limit
        if (petCount < maxPets) {
            document.getElementById('add-pet-btn').style.display = 'inline-block';
        }
    };
}

// Neighborhood Ranking Functionality  
function setupNeighborhoodRanking() {
        console.log('Setting up neighborhood ranking...');
        const availableContainer = document.getElementById('available-neighborhoods');
        const selectedContainer = document.getElementById('selected-neighborhoods');
        const emptyMessage = document.getElementById('empty-message');
        const inputsContainer = document.getElementById('neighborhood-preferences-inputs');
        
        console.log('Available container:', availableContainer);
        console.log('Selected container:', selectedContainer);
        
        if (!availableContainer || !selectedContainer) {
            console.error('Containers not found!');
            return;
        }
        
        // Check if neighborhoods are actually in the DOM
        const neighborhoodItems = availableContainer.querySelectorAll('.neighborhood-item');
        console.log('Found neighborhood items:', neighborhoodItems.length);
        
        let selectedNeighborhoods = [];
        
        // Load existing ranked preferences and remove them from available
        {% if existing_ranked_preferences %}
        const existingPreferences = [
            {% for pref in existing_ranked_preferences %}
            {
                id: {{ pref.neighborhood.id }},
                name: "{{ pref.neighborhood.name|escapejs }}",
                rank: {{ pref.preference_rank }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        existingPreferences.forEach(function(pref) {
            addToSelected(pref.id, pref.name);
            
            // Hide from available list
            const availableItem = availableContainer.querySelector('[data-neighborhood-id="' + pref.id + '"]');
            if (availableItem) {
                availableItem.style.display = 'none';
            }
        });
        {% endif %}
        
        // Add click handlers to available neighborhoods  
        availableContainer.addEventListener('click', function(e) {
            console.log('Available container clicked:', e.target);
            const neighborhoodItem = e.target.closest('.neighborhood-item');
            console.log('Found neighborhood item:', neighborhoodItem);
            
            if (neighborhoodItem && neighborhoodItem.classList.contains('available') && neighborhoodItem.style.display !== 'none') {
                const id = neighborhoodItem.dataset.neighborhoodId;
                const name = neighborhoodItem.querySelector('.neighborhood-name').textContent;
                console.log('Moving neighborhood to selected:', id, name);
                
                // Simple test - just add text to selected area
                selectedContainer.innerHTML += '<div>Test: ' + name + ' (ID: ' + id + ')</div>';
                neighborhoodItem.style.display = 'none';
            }
        });
        
        // Add click handlers to remove from selected
        selectedContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('fa-times')) {
                const neighborhoodItem = e.target.closest('.neighborhood-item');
                const id = neighborhoodItem.dataset.neighborhoodId;
                const name = neighborhoodItem.querySelector('.neighborhood-name').textContent;
                moveNeighborhoodToAvailable(id, name);
                neighborhoodItem.remove();
                updateRankings();
            }
        });
        
        // Create sortable instances
        const availableSortable = new Sortable(availableContainer, {
            group: {
                name: 'neighborhoods',
                pull: true,
                put: true
            },
            sort: false,
            animation: 150,
            onAdd: function(evt) {
                console.log('Item added to available');
                const item = evt.item;
                const id = item.dataset.neighborhoodId;
                
                // Remove from selected and show in available
                item.remove();
                const originalItem = availableContainer.querySelector('[data-neighborhood-id="' + id + '"]');
                if (originalItem) {
                    originalItem.style.display = 'block';
                }
                
                // Update data
                selectedNeighborhoods = selectedNeighborhoods.filter(n => n.id != id);
                updateRankings();
            }
        });
        
        const selectedSortable = new Sortable(selectedContainer, {
            group: {
                name: 'neighborhoods',
                pull: true,
                put: true
            },
            animation: 150,
            onAdd: function(evt) {
                console.log('Item added to selected');
                const item = evt.item;
                const id = item.dataset.neighborhoodId;
                const name = item.querySelector('.neighborhood-name').textContent;
                
                // Remove the dragged item and add properly
                item.remove();
                
                // Hide from available
                const availableItem = availableContainer.querySelector('[data-neighborhood-id="' + id + '"]');
                if (availableItem) {
                    availableItem.style.display = 'none';
                }
                
                // Add to selected
                addToSelected(id, name);
            },
            onUpdate: function(evt) {
                console.log('Selected order updated');
                updateRankings();
            }
        });
        
        function addToSelected(id, name) {
            selectedNeighborhoods.push({id, name});
            
            if (emptyMessage) emptyMessage.style.display = 'none';
            
            const selectedItem = document.createElement('div');
            selectedItem.className = 'neighborhood-item selected';
            selectedItem.dataset.neighborhoodId = id;
            selectedItem.innerHTML = 
                '<div class="d-flex align-items-center">' +
                    '<span class="rank-number me-2 fw-bold text-primary">#' + selectedNeighborhoods.length + '</span>' +
                    '<i class="fas fa-grip-lines drag-handle me-2 text-muted" style="cursor: move;"></i>' +
                    '<span class="neighborhood-name flex-grow-1">' + name + '</span>' +
                    '<i class="fas fa-times text-danger" style="cursor: pointer;"></i>' +
                '</div>';
            
            selectedContainer.appendChild(selectedItem);
            updateRankings();
        }
        
        function moveNeighborhoodToSelected(id, name) {
            // Hide from available
            const availableItem = availableContainer.querySelector('[data-neighborhood-id="' + id + '"]');
            if (availableItem) {
                availableItem.style.display = 'none';
            }
            
            addToSelected(id, name);
        }
        
        function moveNeighborhoodToAvailable(id, name) {
            selectedNeighborhoods = selectedNeighborhoods.filter(n => n.id != id);
            
            // Show the original available item
            const availableItem = availableContainer.querySelector('[data-neighborhood-id="' + id + '"]');
            if (availableItem) {
                availableItem.style.display = 'block';
            }
            
            if (selectedNeighborhoods.length === 0 && emptyMessage) {
                emptyMessage.style.display = 'block';
            }
            
            updateRankings();
        }
        
        function updateRankings() {
            const selectedItems = selectedContainer.querySelectorAll('.neighborhood-item.selected');
            inputsContainer.innerHTML = '';
            
            selectedItems.forEach(function(item, index) {
                const rank = index + 1;
                const id = item.dataset.neighborhoodId;
                
                // Update rank number display
                const rankNumber = item.querySelector('.rank-number');
                if (rankNumber) rankNumber.textContent = '#' + rank;
                
                // Create hidden input for form submission
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'neighborhood_rank_' + rank;
                hiddenInput.value = id;
                inputsContainer.appendChild(hiddenInput);
            });
        }
    }
}

// Simple test functionality first
function setupSimpleTest() {
    console.log('Setting up simple test...');
    const testButtons = document.querySelectorAll('.simple-neighborhood-btn');
    const resultDiv = document.getElementById('simple-test-result');
    
    console.log('Found test buttons:', testButtons.length);
    
    testButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            console.log('Button clicked:', name, id);
            
            resultDiv.innerHTML += '<p>Clicked: <strong>' + name + '</strong> (ID: ' + id + ')</p>';
            this.style.background = '#28a745';
            this.style.color = 'white';
        });
    });
}

// Full working neighborhood ranking system
function setupNeighborhoodRanking() {
    console.log('Setting up neighborhood ranking system...');
    const availableContainer = document.getElementById('available-neighborhoods');
    const selectedContainer = document.getElementById('selected-neighborhoods');
    const emptyMessage = document.getElementById('empty-message');
    const inputsContainer = document.getElementById('neighborhood-preferences-inputs');
    
    if (!availableContainer || !selectedContainer) {
        console.error('Neighborhood containers not found!');
        return;
    }
    
    console.log('Found neighborhood containers');
    let selectedNeighborhoods = [];
    
    // Load existing ranked preferences
    {% if existing_ranked_preferences %}
    console.log('Loading existing preferences...');
    {% for pref in existing_ranked_preferences %}
    // Hide from available list
    var availableItem = availableContainer.querySelector('[data-neighborhood-id="{{ pref.neighborhood.id }}"]');
    if (availableItem) {
        availableItem.style.display = 'none';
    }
    
    // Add to selected
    addToSelected('{{ pref.neighborhood.id }}', '{{ pref.neighborhood.name|escapejs }}');
    {% endfor %}
    {% endif %}
    
    // Click handlers for available neighborhoods
    availableContainer.addEventListener('click', function(e) {
        var neighborhoodItem = e.target.closest('.neighborhood-item');
        if (neighborhoodItem && neighborhoodItem.classList.contains('available') && neighborhoodItem.style.display !== 'none') {
            var id = neighborhoodItem.dataset.neighborhoodId;
            var name = neighborhoodItem.querySelector('.neighborhood-name').textContent;
            
            moveToSelected(id, name);
        }
    });
    
    // Click handlers for removing from selected
    selectedContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('fa-times')) {
            var neighborhoodItem = e.target.closest('.neighborhood-item');
            if (neighborhoodItem) {
                var id = neighborhoodItem.dataset.neighborhoodId;
                removeFromSelected(id);
            }
        }
    });
    
    // Initialize SortableJS for drag and drop
    if (typeof Sortable !== 'undefined') {
        console.log('Initializing SortableJS...');
        
        // Available neighborhoods (drag to selected)
        new Sortable(availableContainer, {
            group: {
                name: 'neighborhoods',
                pull: 'clone',
                put: false
            },
            sort: false,
            onEnd: function(evt) {
                if (evt.to === selectedContainer) {
                    var item = evt.item;
                    var id = item.dataset.neighborhoodId;
                    var name = item.querySelector('.neighborhood-name').textContent;
                    
                    // Remove the dragged clone
                    item.remove();
                    
                    // Add properly to selected
                    moveToSelected(id, name);
                }
            }
        });
        
        // Selected neighborhoods (reorder and drag back)
        new Sortable(selectedContainer, {
            group: 'neighborhoods',
            onEnd: function(evt) {
                if (evt.to === availableContainer) {
                    // Dragged back to available
                    var item = evt.item;
                    var id = item.dataset.neighborhoodId;
                    
                    item.remove();
                    removeFromSelected(id);
                } else {
                    // Just reordered within selected
                    updateRankings();
                }
            }
        });
    } else {
        console.warn('SortableJS not loaded, drag functionality disabled');
    }
    
    function moveToSelected(id, name) {
        // Hide from available
        var availableItem = availableContainer.querySelector('[data-neighborhood-id="' + id + '"]');
        if (availableItem) {
            availableItem.style.display = 'none';
        }
        
        addToSelected(id, name);
    }
    
    function addToSelected(id, name) {
        selectedNeighborhoods.push({id: id, name: name});
        
        if (emptyMessage) emptyMessage.style.display = 'none';
        
        var selectedItem = document.createElement('div');
        selectedItem.className = 'neighborhood-item selected';
        selectedItem.dataset.neighborhoodId = id;
        selectedItem.innerHTML = 
            '<div class="d-flex align-items-center">' +
                '<span class="rank-number me-2 fw-bold text-primary">#' + selectedNeighborhoods.length + '</span>' +
                '<i class="fas fa-grip-lines drag-handle me-2 text-muted" style="cursor: move;" title="Drag to reorder"></i>' +
                '<span class="neighborhood-name flex-grow-1">' + name + '</span>' +
                '<i class="fas fa-times text-danger ms-2" style="cursor: pointer;" title="Remove"></i>' +
            '</div>';
        
        selectedContainer.appendChild(selectedItem);
        updateRankings();
        console.log('Added to selected:', name);
    }
    
    function removeFromSelected(id) {
        selectedNeighborhoods = selectedNeighborhoods.filter(function(n) { return n.id != id; });
        
        // Show in available again
        var availableItem = availableContainer.querySelector('[data-neighborhood-id="' + id + '"]');
        if (availableItem) {
            availableItem.style.display = 'block';
        }
        
        // Remove from selected
        var selectedItem = selectedContainer.querySelector('[data-neighborhood-id="' + id + '"]');
        if (selectedItem) {
            selectedItem.remove();
        }
        
        if (selectedNeighborhoods.length === 0 && emptyMessage) {
            emptyMessage.style.display = 'block';
        }
        
        updateRankings();
        console.log('Removed from selected:', id);
    }
    
    function updateRankings() {
        var selectedItems = selectedContainer.querySelectorAll('.neighborhood-item.selected');
        inputsContainer.innerHTML = '';
        
        selectedItems.forEach(function(item, index) {
            var rank = index + 1;
            var id = item.dataset.neighborhoodId;
            
            // Update rank number display
            var rankNumber = item.querySelector('.rank-number');
            if (rankNumber) rankNumber.textContent = '#' + rank;
            
            // Create hidden input for form submission
            var hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'neighborhood_rank_' + rank;
            hiddenInput.value = id;
            inputsContainer.appendChild(hiddenInput);
        });
        
        console.log('Updated rankings for', selectedItems.length, 'neighborhoods');
    }
}

// Amenities selection system
function setupAmenitiesSelection() {
    console.log('Setting up amenities selection system...');
    const availableContainer = document.getElementById('available-amenities');
    const selectedContainer = document.getElementById('selected-amenities');
    const emptyMessage = document.getElementById('amenities-empty-message');
    const inputsContainer = document.getElementById('amenity-preferences-inputs');
    
    if (!availableContainer || !selectedContainer) {
        console.error('Amenity containers not found!');
        return;
    }
    
    console.log('Found amenity containers');
    let selectedAmenities = [];
    
    // Load existing selected amenities
    {% if existing_selected_amenities %}
    console.log('Loading existing amenity selections...');
    {% for amenity in existing_selected_amenities %}
    // Hide from available list
    var availableItem = availableContainer.querySelector('[data-amenity-id="{{ amenity.id }}"]');
    if (availableItem) {
        availableItem.style.display = 'none';
    }
    
    // Add to selected
    addAmenityToSelected('{{ amenity.id }}', '{{ amenity.name|escapejs }}');
    {% endfor %}
    {% endif %}
    
    // Click handlers for available amenities
    availableContainer.addEventListener('click', function(e) {
        var amenityItem = e.target.closest('.amenity-item');
        if (amenityItem && amenityItem.classList.contains('available') && amenityItem.style.display !== 'none') {
            var id = amenityItem.dataset.amenityId;
            var name = amenityItem.querySelector('.amenity-name').textContent;
            
            moveAmenityToSelected(id, name);
        }
    });
    
    // Click handlers for removing from selected
    selectedContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('fa-times')) {
            var amenityItem = e.target.closest('.amenity-item');
            if (amenityItem) {
                var id = amenityItem.dataset.amenityId;
                removeAmenityFromSelected(id);
            }
        }
    });
    
    function moveAmenityToSelected(id, name) {
        // Hide from available
        var availableItem = availableContainer.querySelector('[data-amenity-id="' + id + '"]');
        if (availableItem) {
            availableItem.style.display = 'none';
        }
        
        addAmenityToSelected(id, name);
    }
    
    function addAmenityToSelected(id, name) {
        selectedAmenities.push({id: id, name: name});
        
        if (emptyMessage) emptyMessage.style.display = 'none';
        
        var selectedItem = document.createElement('div');
        selectedItem.className = 'amenity-item selected';
        selectedItem.dataset.amenityId = id;
        selectedItem.innerHTML = 
            '<div class="d-flex align-items-center">' +
                '<i class="fas fa-star text-warning me-2"></i>' +
                '<span class="amenity-name flex-grow-1">' + name + '</span>' +
                '<i class="fas fa-times text-danger ms-2" style="cursor: pointer;" title="Remove"></i>' +
            '</div>';
        
        selectedContainer.appendChild(selectedItem);
        updateAmenityInputs();
        console.log('Added amenity to selected:', name);
    }
    
    function removeAmenityFromSelected(id) {
        selectedAmenities = selectedAmenities.filter(function(a) { return a.id != id; });
        
        // Show in available again
        var availableItem = availableContainer.querySelector('[data-amenity-id="' + id + '"]');
        if (availableItem) {
            availableItem.style.display = 'block';
        }
        
        // Remove from selected
        var selectedItem = selectedContainer.querySelector('[data-amenity-id="' + id + '"]');
        if (selectedItem) {
            selectedItem.remove();
        }
        
        if (selectedAmenities.length === 0 && emptyMessage) {
            emptyMessage.style.display = 'block';
        }
        
        updateAmenityInputs();
        console.log('Removed amenity from selected:', id);
    }
    
    function updateAmenityInputs() {
        var selectedItems = selectedContainer.querySelectorAll('.amenity-item.selected');
        inputsContainer.innerHTML = '';
        
        selectedItems.forEach(function(item, index) {
            var id = item.dataset.amenityId;
            var selectionNumber = index + 1;
            
            // Create hidden input for form submission
            var hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'amenity_selection_' + selectionNumber;
            hiddenInput.value = id;
            inputsContainer.appendChild(hiddenInput);
        });
        
        console.log('Updated amenity inputs for', selectedItems.length, 'amenities');
    }
}

    } // End initializeStep2
})(); // End self-executing function
</script>

<style>
.neighborhood-item {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.neighborhood-item.available {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.neighborhood-item.available:hover {
    background: #e9ecef;
    border-color: #28a745;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.neighborhood-item.selected {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    cursor: default;
}

.neighborhood-item.selected:hover {
    background: #fff1b3;
}

.neighborhood-list {
    background: #fdfdfd;
}

.drag-handle {
    opacity: 0.5;
}

.drag-handle:hover {
    opacity: 1;
}

.rank-number {
    min-width: 30px;
    text-align: center;
}

.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    background: #007bff !important;
    color: white;
}

.sortable-drag {
    background: #28a745 !important;
    color: white;
}

/* Amenity item styles */
.amenity-item {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.amenity-item.available {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.amenity-item.available:hover {
    background: #e9ecef;
    border-color: #ffc107;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.amenity-item.selected {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    cursor: default;
}

.amenity-item.selected:hover {
    background: #fff1b3;
}

.amenity-list {
    background: #fdfdfd;
}
</style>
{% endblock %}