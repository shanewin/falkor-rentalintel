{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/doorway-forms.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h4 mb-0">{{ step_title }}</h2>
                <a href="{% url 'applicant_dashboard' %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>

            <!-- Progress Bar -->
            <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-body text-center py-3">
                    <h6 class="mb-3">Profile Completion Progress ({{ completion_percentage }}% Complete)</h6>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-warning" style="width: {{ completion_percentage }}%"></div>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <a href="{% url 'profile_step1' %}" class="text-decoration-none">
                                <div class="step-indicator {% if completion_status.step1 %}completed{% endif %} {% if current_step == 1 %}active{% endif %}">
                                    <i class="fas fa-user"></i><br><small>Basic Info</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-4">
                            <a href="{% url 'profile_step2' %}" class="text-decoration-none">
                                <div class="step-indicator {% if completion_status.step2 %}completed{% endif %} {% if current_step == 2 %}active{% endif %}">
                                    <i class="fas fa-home"></i><br><small>Housing Needs</small>
                                </div>
                            </a>
                        </div>
                        <div class="col-4">
                            <a href="{% url 'profile_step3' %}" class="text-decoration-none">
                                <div class="step-indicator {% if completion_status.step3 %}completed{% endif %} {% if current_step == 3 %}active{% endif %}">
                                    <i class="fas fa-briefcase"></i><br><small>Employment</small>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% crispy form form.helper %}
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% static 'js/forms.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prevent double initialization
    if (window.profileStep2Initialized) {
        console.log('Profile Step 2 already initialized, skipping...');
        return;
    }
    window.profileStep2Initialized = true;
    
    console.log('Profile Step 2: DOM Ready - Simple Version!');
    
    // Initialize neighborhood ranking system
    setupNeighborhoodRanking();
    
    // Test pets checkbox
    const petsCheckbox = document.getElementById('has_pets');
    const petsContainer = document.getElementById('pets-container');
    
    console.log('Pets checkbox:', petsCheckbox);
    console.log('Pets container:', petsContainer);
    
    if (petsCheckbox) {
        petsCheckbox.addEventListener('change', function() {
            console.log('Pets checkbox changed:', this.checked);
            if (petsContainer) {
                petsContainer.style.display = this.checked ? 'block' : 'none';
                console.log('Pets container display set to:', this.checked ? 'block' : 'none');
                
                // Add Pet 1 form when pets is checked
                if (this.checked) {
                    addFirstPetForm();
                } else {
                    // Clear pets when unchecked
                    const petsListContainer = document.getElementById('pets-list-container');
                    if (petsListContainer) {
                        petsListContainer.innerHTML = '';
                        petCount = 0; // Reset pet count
                        
                        // Show add button again
                        const addPetBtn = document.getElementById('add-pet-btn');
                        if (addPetBtn) {
                            addPetBtn.style.display = 'inline-block';
                        }
                    }
                }
            }
        });
    }
    
    // Handle +Add Pet button (prevent double-clicking)
    const addPetBtn = document.getElementById('add-pet-btn');
    if (addPetBtn) {
        console.log('Found Add Pet button');
        addPetBtn.addEventListener('click', function() {
            // Prevent rapid clicking
            if (this.disabled) return;
            this.disabled = true;
            
            console.log('Add Pet button clicked');
            addNextPetForm();
            
            // Re-enable after short delay
            var self = this;
            setTimeout(function() {
                self.disabled = false;
            }, 500);
        });
    }
    
    // Track number of pets
    let petCount = 0;
    const maxPets = 5;
    
    // Function to add the first pet form
    function addFirstPetForm() {
        const petsListContainer = document.getElementById('pets-list-container');
        if (petsListContainer && petCount === 0) {
            console.log('Adding Pet 1 form...');
            petCount = 1;
            const petHTML = createSimplePetForm(1);
            petsListContainer.innerHTML = petHTML;
        }
    }
    
    // Function to add additional pet forms
    function addNextPetForm() {
        const petsListContainer = document.getElementById('pets-list-container');
        if (petsListContainer && petCount < maxPets) {
            const nextPetNumber = petCount + 1;
            
            // Check if pet already exists
            if (document.getElementById('pet_' + nextPetNumber)) {
                console.log('Pet ' + nextPetNumber + ' already exists, skipping...');
                return;
            }
            
            petCount++;
            console.log('Adding Pet ' + petCount + ' form...');
            const petHTML = createSimplePetForm(petCount);
            petsListContainer.innerHTML += petHTML;
            
            // Hide add button if at max
            if (petCount >= maxPets) {
                const addPetBtn = document.getElementById('add-pet-btn');
                if (addPetBtn) {
                    addPetBtn.style.display = 'none';
                }
            }
        }
    }
    
    // Simple pet form creator
    function createSimplePetForm(index) {
        return '<div class="pet-container card mb-3" id="pet_' + index + '">' +
            '<div class="card-header">' +
                '<h6 class="mb-0"><i class="fas fa-paw"></i> Pet ' + index + '</h6>' +
            '</div>' +
            '<div class="card-body">' +
                '<div class="row">' +
                    '<div class="col-md-6 mb-3">' +
                        '<label class="form-label">Pet Name</label>' +
                        '<input type="text" name="pet_name_' + index + '" class="form-control" placeholder="Your pet\'s name">' +
                    '</div>' +
                    '<div class="col-md-6 mb-3">' +
                        '<label class="form-label">Pet Type</label>' +
                        '<select name="pet_type_' + index + '" class="form-select">' +
                            '<option value="">Select pet type</option>' +
                            '<option value="Dog">Dog</option>' +
                            '<option value="Cat">Cat</option>' +
                            '<option value="Bird">Bird</option>' +
                            '<option value="Other">Other</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="mb-3">' +
                    '<label class="form-label">Pet Photos</label>' +
                    '<input type="file" name="pet_photo_' + index + '" accept="image/*" class="form-control">' +
                    '<small class="text-muted">Upload a photo of your pet</small>' +
                '</div>' +
                '<div class="mb-3">' +
                    '<label class="form-label">Tell us about your pet</label>' +
                    '<textarea name="pet_description_' + index + '" class="form-control" rows="3" ' +
                        'placeholder="Weight, temperament, special needs, etc."></textarea>' +
                '</div>' +
            '</div>' +
        '</div>';
    }
    
    // Full neighborhood ranking system
    function setupNeighborhoodRanking() {
        console.log('Setting up neighborhood ranking system...');
        const availableContainer = document.getElementById('available-neighborhoods');
        const selectedContainer = document.getElementById('selected-neighborhoods');
        const emptyMessage = document.getElementById('empty-message');
        const inputsContainer = document.getElementById('neighborhood-preferences-inputs');
        
        if (!availableContainer || !selectedContainer) {
            console.error('Neighborhood containers not found!');
            return;
        }
        
        console.log('Found neighborhood containers');
        let selectedNeighborhoods = [];
        
        // Load existing ranked preferences
        {% if existing_ranked_preferences %}
        console.log('Loading existing preferences...');
        var existingPreferences = [
            {% for pref in existing_ranked_preferences %}
            {
                id: {{ pref.neighborhood.id }},
                name: "{{ pref.neighborhood.name|escapejs }}",
                rank: {{ pref.preference_rank }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        existingPreferences.forEach(function(pref) {
            // Hide from available list
            var availableItem = availableContainer.querySelector('[data-neighborhood-id="' + pref.id + '"]');
            if (availableItem) {
                availableItem.style.display = 'none';
            }
            
            // Add to selected
            addToSelected(pref.id, pref.name);
        });
        {% endif %}
        
        // Click handlers for available neighborhoods
        availableContainer.addEventListener('click', function(e) {
            var neighborhoodItem = e.target.closest('.neighborhood-item');
            if (neighborhoodItem && neighborhoodItem.classList.contains('available') && neighborhoodItem.style.display !== 'none') {
                var id = neighborhoodItem.dataset.neighborhoodId;
                var name = neighborhoodItem.querySelector('.neighborhood-name').textContent;
                
                moveToSelected(id, name);
            }
        });
        
        // Click handlers for removing from selected
        selectedContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('fa-times')) {
                var neighborhoodItem = e.target.closest('.neighborhood-item');
                if (neighborhoodItem) {
                    var id = neighborhoodItem.dataset.neighborhoodId;
                    removeFromSelected(id);
                }
            }
        });
        
        // Initialize SortableJS for drag and drop
        if (typeof Sortable !== 'undefined') {
            console.log('Initializing SortableJS...');
            
            // Available neighborhoods (drag to selected)
            new Sortable(availableContainer, {
                group: {
                    name: 'neighborhoods',
                    pull: 'clone',
                    put: false
                },
                sort: false,
                onEnd: function(evt) {
                    if (evt.to === selectedContainer) {
                        var item = evt.item;
                        var id = item.dataset.neighborhoodId;
                        var name = item.querySelector('.neighborhood-name').textContent;
                        
                        // Remove the dragged clone
                        item.remove();
                        
                        // Add properly to selected
                        moveToSelected(id, name);
                    }
                }
            });
            
            // Selected neighborhoods (reorder and drag back)
            new Sortable(selectedContainer, {
                group: 'neighborhoods',
                onEnd: function(evt) {
                    if (evt.to === availableContainer) {
                        // Dragged back to available
                        var item = evt.item;
                        var id = item.dataset.neighborhoodId;
                        
                        item.remove();
                        removeFromSelected(id);
                    } else {
                        // Just reordered within selected
                        updateRankings();
                    }
                }
            });
        } else {
            console.warn('SortableJS not loaded, drag functionality disabled');
        }
        
        function moveToSelected(id, name) {
            // Hide from available
            var availableItem = availableContainer.querySelector('[data-neighborhood-id="' + id + '"]');
            if (availableItem) {
                availableItem.style.display = 'none';
            }
            
            addToSelected(id, name);
        }
        
        function addToSelected(id, name) {
            selectedNeighborhoods.push({id: id, name: name});
            
            if (emptyMessage) emptyMessage.style.display = 'none';
            
            var selectedItem = document.createElement('div');
            selectedItem.className = 'neighborhood-item selected';
            selectedItem.dataset.neighborhoodId = id;
            selectedItem.innerHTML = 
                '<div class="d-flex align-items-center">' +
                    '<span class="rank-number me-2 fw-bold text-primary">#' + selectedNeighborhoods.length + '</span>' +
                    '<i class="fas fa-grip-lines drag-handle me-2 text-muted" style="cursor: move;" title="Drag to reorder"></i>' +
                    '<span class="neighborhood-name flex-grow-1">' + name + '</span>' +
                    '<i class="fas fa-times text-danger ms-2" style="cursor: pointer;" title="Remove"></i>' +
                '</div>';
            
            selectedContainer.appendChild(selectedItem);
            updateRankings();
            console.log('Added to selected:', name);
        }
        
        function removeFromSelected(id) {
            selectedNeighborhoods = selectedNeighborhoods.filter(function(n) { return n.id != id; });
            
            // Show in available again
            var availableItem = availableContainer.querySelector('[data-neighborhood-id="' + id + '"]');
            if (availableItem) {
                availableItem.style.display = 'block';
            }
            
            // Remove from selected
            var selectedItem = selectedContainer.querySelector('[data-neighborhood-id="' + id + '"]');
            if (selectedItem) {
                selectedItem.remove();
            }
            
            if (selectedNeighborhoods.length === 0 && emptyMessage) {
                emptyMessage.style.display = 'block';
            }
            
            updateRankings();
            console.log('Removed from selected:', id);
        }
        
        function updateRankings() {
            var selectedItems = selectedContainer.querySelectorAll('.neighborhood-item.selected');
            inputsContainer.innerHTML = '';
            
            selectedItems.forEach(function(item, index) {
                var rank = index + 1;
                var id = item.dataset.neighborhoodId;
                
                // Update rank number display
                var rankNumber = item.querySelector('.rank-number');
                if (rankNumber) rankNumber.textContent = '#' + rank;
                
                // Create hidden input for form submission
                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'neighborhood_rank_' + rank;
                hiddenInput.value = id;
                inputsContainer.appendChild(hiddenInput);
            });
            
            console.log('Updated rankings for', selectedItems.length, 'neighborhoods');
        }
    }
});
</script>

<!-- Include SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<style>
.neighborhood-item {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.neighborhood-item.available {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.neighborhood-item.available:hover {
    background: #e9ecef;
    border-color: #28a745;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.neighborhood-item.selected {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    cursor: default;
}

.neighborhood-item.selected:hover {
    background: #fff1b3;
}

.neighborhood-list {
    background: #fdfdfd;
}

.drag-handle {
    opacity: 0.5;
}

.drag-handle:hover {
    opacity: 1;
}

.rank-number {
    min-width: 30px;
    text-align: center;
}

.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    background: #007bff !important;
    color: white;
}

.sortable-drag {
    background: #28a745 !important;
    color: white;
}
</style>

{% endblock %}
{% endblock %}